{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 style="font-weight: bold;">Settings</h1>
    </div>
    <p class="text-muted mb-4">Configure your application settings, Plex connection, and email preferences.</p>
    
    {% if alert %}
        <p style="color: #01b301; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ alert }}</p>
    {% endif %}
    {% if error %}
        <p style="color: #770010; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ error }}</p>
    {% endif %}
    <div class="foreground">
        <div style="margin: 0px 0px 0px 15px;">
            <div>
                <h3>Plex Account</h3>
                <button id="connect_plex" class="button">Connect Plex</button>
                <div id="plex_status">{% if settings.plex_token %}<p style="padding-left: 8px; color: #01b301; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">Connected</p>{% endif %}</div>
            </div><br>

            <form method="POST" id="settings_form">
                <label for="from_email">From:</label><br>
                <input type="email" id="from_email" name="from_email"
                    {% if settings.from_email !="" %}value="{{ settings.from_email }}"{% endif %}
                    placeholder="Your Email" required><br><br>

                <label for="alias_email">Send-As Alias (Optional):</label><br>
                <input type="email" id="alias_email" name="alias_email"
                    {% if settings.from_email !="" %}value="{{ settings.alias_email }}"{% endif %}
                    placeholder="Blank if no alias"><br><br>

                <label for="password">Password:</label><br>
                <input type="password" id="password" name="password"
                    {% if settings.from_email !="" %}value="{{ settings.password }}"{% endif %}
                    placeholder="Email Password or App Password" required><br><br>

                <label for="smtp_server">SMTP Server:</label><br>
                <input type="text" id="smtp_server" name="smtp_server"
                    {% if settings.from_email !="" %}value="{{ settings.smtp_server }}"{% endif %}
                    placeholder="SMTP Server (e.g. smtp.gmail.com)" required><br><br>

                <label for="smtp_port">SMTP Port:</label><br>
                <input type="number" id="smtp_port" name="smtp_port"
                    {% if settings.from_email !="" %}value="{{ settings.smtp_port }}"{% endif %}
                    placeholder="SMTP Port (465 for SSL)" required><br><br>

                <label for="server_name">Plex Server Name:</label><br>
                <input type="text" id="server_name" name="server_name"
                    {% if settings.from_email !="" %}value="{{ settings.server_name }}"{% endif %}
                    placeholder="Paramount Plex" required><br><br>

                <label for="tautulli_url">Tautulli Base URL (Optional):</label><br>
                <input type="text" id="tautulli_url" name="tautulli_url"
                    {% if settings.from_email !="" %}value="{{ settings.tautulli_url }}"{% endif %}
                    placeholder="http://localhost:8181"><br><br>

                <label for="tautulli_api">Tautulli API Key (Optional):</label><br>
                <input type="text" id="tautulli_api" name="tautulli_api"
                    {% if settings.from_email !="" %}value="{{ settings.tautulli_api }}"{% endif %}
                    placeholder="Tautulli API Key"><br><br>

                <label for="conjurr_url">Conjurr Base URL (Optional):</label><br>
                <input type="text" id="conjurr_url" name="conjurr_url"
                    {% if settings.from_email !="" %}value="{{ settings.conjurr_url }}"{% endif %}
                    placeholder="http://localhost:2665"><br><br>
                
                <button id="apply_settings" class="button">Apply Settings</button>
            </form>
        </div>
        <script>
            document.getElementById('settings_form').addEventListener('submit', (e) => {
                showSpinner('Applying settings...');
            });
        </script>
        <script>
            function openCenteredPopup(url, w = 520, h = 680, name = 'plex-auth', offsetX = 0, offsetY = 0) {
                const dualLeft = window.screenLeft ?? window.screenX;
                const dualTop  = window.screenTop  ?? window.screenY;

                const vw = window.innerWidth  || document.documentElement.clientWidth  || screen.width;
                const vh = window.innerHeight || document.documentElement.clientHeight || screen.height;

                let left = dualLeft + (vw - w) / 2 + offsetX;
                let top  = dualTop  + (vh - h) / 2 + offsetY;

                left = Math.max(dualLeft, Math.min(left, dualLeft + vw - w));
                top  = Math.max(dualTop,  Math.min(top,  dualTop  + vh - h));

                const features = `width=${w},height=${h},left=${Math.round(left)},top=${Math.round(top)},` +
                                `resizable=yes,scrollbars=yes,toolbar=no,menubar=no,location=yes,noopener,noreferrer`;

                const win = window.open(url, name, features);
                if (!win) return window.open(url, '_blank', 'noopener,noreferrer');
                win.focus();
                return win;
            }
            
            const button = document.getElementById('connect_plex');
            const statusEl = document.getElementById('plex_status');
            let pollTimer = null;
            let connected_to_plex = false;

            button?.addEventListener('click', async () => {
                button.disabled = true;
                statusEl.textContent = '';
                showSpinner('Waiting for Plex approval...');

                try {
                    const r = await fetch('/api/plex/pin', {method: 'POST'});
                    if (!r.ok) throw new Error('Failed to create PIN');
                    const data = await r.json();

                    hideSpinner();
                    showSpinner(`Enter this code into Plex: ${data.code}`);
                    const authWin = openCenteredPopup(data.auth_url, 520, 480, 'plex-auth', 520);

                    const start = Date.now();
                    const timeoutMs = (data.expires_in ?? 600) * 1000;

                    async function waitForPIN() {
                        return new Promise((resolve, reject) => {
                            const poll = async () => {
                                const pollr = await fetch(`/api/plex/pin/${data.pin_id}`);
                                const polld = await pollr.json();
                                if (polld.connected) {
                                    hideSpinner();
                                    statusEl.textContent = 'Connected! Your Plex token is saved.';
                                    clearInterval(pollTimer);
                                    button.disabled = false;
                                    resolve(polld);
                                    return;
                                }
                                if (Date.now() - start > timeoutMs) {
                                    hideSpinner();
                                    statusEl.textContent = 'PIN expired. Please try again.';
                                    clearInterval(pollTimer);
                                    button.disabled = false;
                                    reject(new Error('PIN expired.'));
                                }
                            };
                            pollTimer = setInterval(poll, 1500);
                            poll();
                        });
                    }

                    async function getPlexInfo(authWin) {
                        const polld = await waitForPIN();

                        showSpinner('Retreiving Plex information...');
                        const infor = await fetch('/api/plex/info', {method: 'GET'});
                        if (!infor.ok) throw new Error('Failed to get info');
                        const infod = await infor.json();

                        if (infod.connected) {
                            try { if (authWin && !authWin.closed) authWin.close(); } catch {}
                            hideSpinner();
                            statusEl.textContent = 'Plex information retrieved.';
                            setTimeout(() => location.replace(location.href), 2000);
                            return;
                        }
                    }

                    getPlexInfo(authWin);
                } catch (e) {
                    hideSpinner();
                    statusEl.textContent = 'Error starting Plex connection.';
                    button.disabled = false;
                }
            });

            // Add Ctrl+S keyboard shortcut to save settings
            document.addEventListener('keydown', function(event) {
                if (event.ctrlKey && event.key === 's') {
                    event.preventDefault(); // Prevent browser's default save dialog
                    
                    // Trigger the form submission
                    const settingsForm = document.getElementById('settings_form');
                    const applyButton = document.getElementById('apply_settings');
                    
                    if (settingsForm && applyButton) {
                        // Show spinner like the normal submit does
                        showSpinner('Applying settings...');
                        
                        // Submit the form
                        settingsForm.submit();
                    }
                }
            });
        </script>
    </div>
</div>
{% endblock %}
