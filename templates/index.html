{% extends "base.html" %}
{% block title %}newsletterr{% endblock %}
{% block content %}
<div class="container">
    <h1>Dashboard</h1><br>
    {% if alert %}
        <p style="color: #01b301;">{{ alert }}</p>
    {% endif %}
    {% if error %}
        <p style="color: #770010;">{{ error }}</p>
    {% endif %}
    <div class="foreground">
        <div>
            <table style="height: 75%; width: 100%;">
                <tr style="height: 100%; padding: 10px;">
                    <td style="width: 20%; padding: 10px;">
                        <form method="POST">
                            <label for="days_to_pull">Time Range:</label>
                            <input type="number" id="days_to_pull" name="days_to_pull" value="30" /><br><br>
                            <button class="btn btn-info">Get Stats\Users</button>
                        </form><br>
                        <form method="POST" action="/send_email">
                            BCC: <textarea type="text" name="to_emails" id="to_emails" placeholder="Recipient Email"
                                rows="10" cols="40" value="" required>{{ user_emails | join(', ') }}</textarea><br><br>
                            Subject: <input type="text" name="subject" id="subject" placeholder="Subject"
                                required><br><br>
                            <label for="layout">Choose a layout:</label>
                            <select id="layout" name="layout" onchange="updatePreview()">
                                <option value="none">Plain Text</option>
                                <option value="standard">Standard</option>
                            </select><br><br>
                            <textarea name="email_text" id="email_text" placeholder="Write your message..." rows="10"
                                cols="40" oninput="updatePreview()" required></textarea><br><br>
                            <label for="graph_placeholder">Graph Placeholder:</label>
                            <input type="text" id="graph_placeholder" name="graph_placeholder" value="[GRAPHS]"
                                oninput="updatePreview()"><br><br>
                            <label for="stat_placeholder">Stat Placeholder:</label>
                            <input type="text" id="stat_placeholder" name="stat_placeholder" value="[STATS]"
                                oninput="updatePreview()"><br><br>
                        </form>
                        <button id="sendEmailBtn" class="btn btn-info">Send Email with Selected Graphs</button>
                    </td>
                    <td style="width: 40%; padding: 10px;">
                        Preview: <iframe class="frame" id="preview"></iframe>
                    </td>
                    <td style="width: 40%; padding: 10px;">
                        {% if stats %}
                            <h2>Select a Stat Category</h2>
                            <select id="statSelector" class="form-select w-50 mb-4">
                                <option selected>Choose an option...</option>
                                {% for stat in stats %}
                                    <option value="stat-{{ loop.index0 }}">{{ stat.stat_title }}</option>
                                {% endfor %}
                            </select>
                            {% for stat in stats %}
                                <div class="stat-checkbox-container d-none" id="checkbox-stat-{{ loop.index0 }}">
                                    <label>
                                        <input type="checkbox" class="stat-checkbox" value="stat-{{ loop.index0 }}">
                                        Include {{ stat.stat_title }} in email
                                    </label>
                                </div>
                                <div id="stat-{{ loop.index0 }}" class="stat-table d-none">
                                    <div class="card my-4">
                                        <div class="card-header bg-primary text-white">
                                            {{ stat.stat_title }}
                                        </div>
                                        <div class="card-body p-0">
                                            {% if stat.rows %}
                                                <table class="table table-striped m-0">
                                                    <thead class="table-dark">
                                                        <tr>
                                                            <th>Title</th>
                                                            <th>Year</th>
                                                            <th>Plays</th>
                                                            <th>Hours Played</th>
                                                            <th>Type</th>
                                                            <th>Rating</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for row in stat.rows %}
                                                            <tr>
                                                                <td>{{ row.title }}</td>
                                                                <td>{{ row.year }}</td>
                                                                <td>{{ row.total_plays }}</td>
                                                                {% if row.total_duration %}
                                                                    <td>{{ (row.total_duration/60/60)|round(2) }}</td>
                                                                {% else %}
                                                                    <td>no time data</td>
                                                                {% endif %}
                                                                <td>{{ row.media_type }}</td>
                                                                <td>{{ row.content_rating }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            {% else %}
                                                <p class="m-3">No data available.</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </td>
                </tr>
            </table>
            <table style="height: 25%; width: 100%;">
                <tr style="height: 100%; padding: 10px;">
                    <td style="width: 15%; padding: 10px;">
                        {% if graph_data != [{},{}] %}
                            <h2>Select a Graph</h2>
                            <select id="graphSelector" class="form-select w-100 mb-4">
                                <option selected>Choose an option...</option>
                                {% for graph in graph_data %}
                                    <option value="graph-{{ loop.index0 }}">{{ graph_commands[loop.index0].name }}</option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    </td>
                    <td style="width: 85%; padding: 10px;">
                        {% for graph in graph_data %}
                            <div class="graph-checkbox-container d-none" id="checkbox-graph-{{ loop.index0 }}">
                                <label>
                                    <input type="checkbox" class="graph-checkbox" value="graph-{{ loop.index0 }}">
                                    Include {{ graph_commands[loop.index0].name }} in email
                                </label>
                            </div>
                            <div class="graph-table d-none" id="graph-{{ loop.index0 }}"></div>
                        {% endfor %}
                    </td>
                </tr>
            </table>
        </div>
        <script>
            async function updatePreview() {
                const raw = document.getElementById('email_text').value;
                const layout = document.getElementById('layout').value;
                const serverName = "{{ settings.server_name }}";
                const subject = document.getElementById('subject').value;
                let body = raw.replace(/\n/g, "<br>");
                let html = "";

                const selectedGraphs = Array.from(document.querySelectorAll('.graph-checkbox:checked'))
                    .map(cb => cb.value);
                const selectedStats = Array.from(document.querySelectorAll('.stat-checkbox:checked'))
                    .map(cb => cb.value);

                let graphImagesHTML = "";
                for (let id of selectedGraphs) {
                    const chart = Highcharts.charts.find(c => c && c.renderTo.id === id);
                    if (chart) {
                        const svg = chart.getSVG();
                        const canvas = document.createElement("canvas");
                        const ctx = canvas.getContext("2d");
                        const img = new Image();

                        await new Promise((resolve, reject) => {
                            img.onload = () => {
                                canvas.width = img.width;
                                canvas.height = img.height;
                                ctx.drawImage(img, 0, 0);
                                const dataUrl = canvas.toDataURL("image/png");
                                graphImagesHTML += `<img src="${dataUrl}" style="max-width: 100%; margin-bottom: 10px;">`;
                                resolve();
                            };
                            img.onerror = reject;
                            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
                        });
                    }
                }

                let statImagesHTML = "";
                for (let id of selectedStats) {
                    const tableElement = document.getElementById(id);
                    if (tableElement) {
                        const wasHidden = tableElement.classList.contains('d-none');
                        if (wasHidden) {
                            tableElement.classList.remove('d-none');
                        }
                        await new Promise(resolve => setTimeout(resolve, 50));

                        const canvas = await html2canvas(tableElement, {
                            backgroundColor: null,
                            scale: 1
                        });

                        const dataUrl = canvas.toDataURL("image/png");
                        statImagesHTML += `<img src="${dataUrl}" style="max-width: 100%; margin-bottom: 10px;">`;

                        if (wasHidden) {
                            tableElement.classList.add('d-none');
                        }
                    }
                }

                const graphPlaceholder = document.getElementById('graph_placeholder').value;
                const statPlaceholder = document.getElementById('stat_placeholder').value;
                let gContent = body;

                if (raw.includes(graphPlaceholder)) {
                    gContent = body.replace(graphPlaceholder, graphImagesHTML);
                } else {
                    gContent = `${body}`;
                }

                if (raw.includes(statPlaceholder)) {
                    content = gContent.replace(statPlaceholder, statImagesHTML);
                } else {
                    content = `${gContent}`;
                }

                switch (layout) {
                    case "standard":
                        html = `
                                <html><body style="font-family: Arial;">
                                    <table class="body" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 90%;" border="0" cellspacing="0" cellpadding="0">
                                        <tbody>
                                            <tr>
                                                <td class="preview-container" style="font-family: 'Open Sans', Helvetica, Arial, sans-serif; font-size: 14px; vertical-align: top; display: block; max-width: 925px; padding: 5px; width: 925px; margin: 0 auto !important;">
                                                    <div class="content" style="box-sizing: border-box; display: block; margin: 0 auto; max-width: 1037px; padding: 5px;"><span class="preheader" style="color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;">${serverName} Newsletter</span>
                                                        <table class="main" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #282A2D; border-radius: 3px; color: #ffffff;" border="0" cellspacing="0" cellpadding="3">
                                                            <tbody>
                                                                <tr>
                                                                    <td class="wrapper" style="font-family: 'Open Sans', Helvetica, Arial, sans-serif; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 5px; overflow: auto;">
                                                                        <div class="header" style="width: 50%; height: 10px; text-align: center;"><img class="header-img" style="border: none; -ms-interpolation-mode: bicubic; max-width: 9%; width: 492px; height: 20px; margin-left: -35px;" src="https://d15k2d11r6t6rl.cloudfront.net/public/users/Integrators/669d5713-9b6a-46bb-bd7e-c542cff6dd6a/3bef3c50f13f4320a9e31b8be79c6ad2/Plex%20Logo%20Update%202022/plex-logo-heavy-stroke.png" width="492" height="90" /></div>
                                                                        <div class="server-name" style="font-size: 25px; text-align: center; margin-bottom: 0;">${serverName} Newsletter</div>
                                                                    </td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="footer" style="font-family: 'Open Sans', Helvetica, Arial, sans-serif; font-size: 12px; vertical-align: top; clear: both; margin-top: 0; text-align: center; width: 100%;">
                                                                        <h1 class="footer-bar" style="margin-left: auto; margin-right: auto; width: 250px; border-top: 1px solid #E5A00D; margin-top: 5px;">${subject}</h1>
                                                                        <p>
                                                                            ${content}
                                                                        </p>
                                                                        <div class="footer-bar" style="margin-left: auto; margin-right: auto; width: 250px; border-top: 1px solid #E5A00D; margin-top: 25px;">&nbsp;</div>
                                                                        <div class="content-block powered-by" style="padding-bottom: 10px; padding-top: 0;">Generated for Plex Media Server by newsletterr</div>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table></body></html>`;
                        break;
                    default:
                        html = `<html><body>${content}</body></html>`;
                }

                document.getElementById('preview').srcdoc = html;
            }

            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('email_text').addEventListener('input', updatePreview);
                document.getElementById('layout').addEventListener('change', updatePreview);
                document.querySelectorAll('.graph-checkbox').forEach(cb => {
                    cb.addEventListener('change', updatePreview);
                });
                document.querySelectorAll('.stat-checkbox').forEach(cb => {
                    cb.addEventListener('change', updatePreview);
                });
            });
        </script>
        <script>
            document.getElementById('statSelector').addEventListener('change', function () {
                const selectedId = this.value;
                document.querySelectorAll('.stat-table').forEach(el => {
                    el.classList.add('d-none');
                });
                document.querySelectorAll('.stat-checkbox-container').forEach(el => el.classList.add('d-none'));

                document.getElementById(selectedId).classList.remove('d-none');
                document.getElementById(`checkbox-${selectedId}`).classList.remove('d-none');
            });
        </script>
        <script>
            function showGraph(index) {
                document.querySelectorAll('.graph-table').forEach(el => el.classList.add('d-none'));
                document.querySelectorAll('.graph-checkbox-container').forEach(el => el.classList.add('d-none'));

                document.getElementById(`graph-${index}`).classList.remove('d-none');
                document.getElementById(`checkbox-graph-${index}`).classList.remove('d-none');
            }
        </script>
        <script>
            const graphDataList = {{ graph_data | tojson }};
            const graphCommands = {{ graph_commands | tojson }};

            const renderedCharts = new Set();

            document.getElementById('graphSelector').addEventListener('change', function () {
                const selectedId = this.value;

                document.querySelectorAll('.graph-table').forEach(el => el.classList.add('d-none'));

                const container = document.getElementById(selectedId);
                container.classList.remove('d-none');

                if (!renderedCharts.has(selectedId)) {
                    const index = parseInt(selectedId.split('-')[1]);
                    const graphData = graphDataList[index];

                    Highcharts.chart(selectedId, {
                        chart: { type: 'line' },
                        title: { text: graphCommands[index].name },
                        exporting: {
                            enabled: true
                        },
                        xAxis: { categories: graphData.categories },
                        yAxis: { title: { text: 'Plays' } },
                        series: graphData.series
                    });

                    renderedCharts.add(selectedId);

                    showGraph(index)
                }
            });
        </script>
        <script>
            document.getElementById('sendEmailBtn').addEventListener('click', async () => {
                const selectedGraphs = Array.from(document.querySelectorAll('.graph-checkbox:checked'))
                    .map(cb => cb.value);
                const selectedStats = Array.from(document.querySelectorAll('.stat-checkbox:checked'))
                    .map(cb => cb.value);

                const to_emails = document.getElementById('to_emails').value;
                const subject = document.getElementById('subject').value;
                const email_text = document.getElementById('email_text').value;
                const layout = document.getElementById('layout').value;
                const graphImages = [];
                const statImages = [];

                for (let id of selectedGraphs) {
                    const chart = Highcharts.charts.find(c => c && c.renderTo.id === id);
                    if (chart) {
                        const svg = chart.getSVG();
                        const canvas = document.createElement("canvas");
                        const ctx = canvas.getContext("2d");
                        const img = new Image();

                        await new Promise((resolve, reject) => {
                            img.onload = () => {
                                canvas.width = img.width;
                                canvas.height = img.height;
                                ctx.drawImage(img, 0, 0);
                                const dataUrl = canvas.toDataURL("image/png");
                                graphImages.push({ id, img: dataUrl });
                                resolve();
                            };
                            img.onerror = reject;
                            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
                        });
                    }
                }

                for (let id of selectedStats) {
                    const tableElement = document.getElementById(id);
                    if (tableElement) {
                        const wasHidden = tableElement.classList.contains('d-none');
                        if (wasHidden) {
                            tableElement.classList.remove('d-none');
                        }
                        await new Promise(resolve => setTimeout(resolve, 50));

                        const canvas = await html2canvas(tableElement, {
                            backgroundColor: null,
                            scale: 1
                        });

                        const dataUrl = canvas.toDataURL("image/png");
                        statImages.push({ id, img: dataUrl });

                        if (wasHidden) {
                            tableElement.classList.add('d-none');
                        }
                    }
                }

                fetch('/send_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to_emails,
                        subject,
                        email_text,
                        layout,
                        graphs: graphImages,
                        stats: statImages
                    })
                }).then(resp => {
                    if (resp.ok) {
                        alert("Email sent!");
                    } else {
                        resp.json().then(data => {
                            alert("Error sending email: " + data.error);
                        });
                    }
                }).catch(err => {
                    console.error("Error sending email:", err);
                });
            });
        </script>
    </div>
</div>
{% endblock %}
