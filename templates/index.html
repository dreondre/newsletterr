{% extends "base.html" %}
{% block title %}newsletterr{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>newsletterr dashboard</h1>
        <button id="sendEmailBtn" class="btn btn-success btn-lg px-5 py-3" style="font-size: 1.6rem; font-weight: 700; min-width: 220px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
            📧 Send Email
        </button>
    </div>
    {% if alert %}
        <p id="alert_p" style="color: #01b301; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ alert }}</p>
    {% endif %}
    {% if error %}
        <p id="error_p" style="color: #770010; text-shadow: 1px 0 #000, 0 1px #000, -1px 0 #000, 0 -1px #000;">{{ error }}</p>
    {% endif %}
    <div class="foreground">
        <div>
            <table style="height: 60%; width: 100%;">
                <tr style="height: 100%; padding: 10px;">
                    <td style="width: 20%; padding: 10px; vertical-align: top;">
                        <form method="POST" id="stats_form">
                            <label for="items_to_pull">Recently Added Items (#):</label>
                            <input type="number" id="items_to_pull" name="items_to_pull" value="10" style="width: 8.5rem; margin-bottom: 8px;" /><br>
                            <label for="days_to_pull">Time Range (days):</label>
                            <input type="number" id="days_to_pull" name="days_to_pull" value="30" /><br>
                            <button id="time_range_week" type="button" class="button">7</button>
                            <button id="time_range_month" type="button" class="button">30</button>
                            <button id="time_range_quarter" type="button" class="button">90</button>
                            <button id="time_range_two_q" type="button" class="button">180</button>
                            <button id="time_range_three_q" type="button" class="button">270</button>
                            <button id="time_range_year" type="button" class="button">365</button>
                            <button type="submit" class="button">Get Stats\Users</button>
                            <button id="clear_cache_btn" type="button" class="button" 
                                    style="background-color: #dc3545; margin-top: 5px;"
                                    title="Clear cached data to force fresh fetch">Clear Cache</button>
                        </form>
                        
                        <!-- Cache Status Display -->
                        {% if cache_info %}
                        <div class="card mt-3" style="border: 1px solid #dee2e6;">
                            <div class="card-header d-flex justify-content-between align-items-center" 
                                 style="cursor: pointer; padding: 8px 12px; background-color: #f8f9fa;" 
                                 onclick="document.getElementById('cache-status-collapse').classList.toggle('d-none')">
                                <h6 class="mb-0" style="font-size: 0.85rem;">Cache Status</h6>
                                <span style="font-size: 0.8rem;">▼</span>
                            </div>
                            <div id="cache-status-collapse" class="card-body d-none" style="padding: 8px 12px; font-size: 0.8rem;">
                                {% for key, info in cache_info.items() %}
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span style="text-transform: capitalize;">{{ key.replace('_', ' ') }}:</span>
                                    {% if info.exists %}
                                        {% if info.is_fresh %}
                                            <span class="text-success">✓ Fresh ({{ "%.1f"|format(info.age_hours) }}h)</span>
                                        {% elif info.is_usable %}
                                            <span class="text-warning">⚠ Old ({{ "%.1f"|format(info.age_hours) }}h)</span>
                                        {% else %}
                                            <span class="text-danger">✗ Expired</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">○ None</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                                <small class="text-muted d-block mt-2">Cache refreshes daily automatically. Use "Get Stats\Users" to refresh manually.</small>
                            </div>
                        </div>
                        {% endif %}
                        <!-- Expandable BCC Email Section -->
                        <div class="card mb-3" style="margin-top: 20px;">
                            <div class="card-header d-flex justify-content-between align-items-center" 
                                 style="cursor: pointer;" 
                                 onclick="document.getElementById('bcc-collapse').classList.toggle('d-none')">
                                <h5 class="mb-0">Email Recipients</h5>
                                <span id="bcc-toggle-icon" style="transition: transform 0.3s;">▼</span>
                            </div>
                            <div id="bcc-collapse" class="card-body">
                                <form method="POST" action="/send_email">
                                    <!-- Email List Management -->
                                    <div class="mb-3">
                                        <label class="form-label">Email Lists:</label>
                                        <div class="d-flex gap-2 align-items-center">
                                            <select id="email_list_selector" class="form-select" style="flex: 1;">
                                                <option value="(Save new list)">(Save new list)</option>
                                                <option value="ALL">ALL</option>
                                                <option value="Custom" selected>Custom</option>
                                                {% for list in email_lists|sort(attribute='name') %}
                                                <option value="{{ list.id }}" data-emails="{{ list.emails }}">{{ list.name }}</option>
                                                {% endfor %}
                                            </select>
                                            <button id="delete_list_btn" type="button" class="btn btn-sm btn-danger d-none">Delete</button>
                                        </div>
                                        
                                        <!-- Save New List Input (initially hidden) -->
                                        <div id="save_list_container" class="mt-2 d-none">
                                            <div class="d-flex gap-2">
                                                <input type="text" id="new_list_name" class="form-control" placeholder="Enter list name" />
                                                <button id="save_list_btn" type="button" class="btn btn-sm btn-success">Save</button>
                                                <button id="cancel_save_btn" type="button" class="btn btn-sm btn-secondary">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <label class="form-label">BCC:</label>
                                    <div id="bcc_chips" class="nl-chips" role="listbox" aria-label="BCC recipients">
                                        <input id="email_chip_input"
                                                type="text"
                                                placeholder="Add BCC emails"
                                                aria-label="Add recipient" />
                                    </div>
                                    <textarea name="to_emails" id="to_emails" class="d-none">
                                        {{ user_dict.values() | join(', ') }}
                                    </textarea>
                                </form>
                            </div>
                        </div>

                        {% if not user_dict %}
                            <button id="pullRecsBtn" class="button opacity-50 cursor-not-allowed" disabled>Get Recommendations</button>
                        {% else %}
                            <button id="pullRecsBtn" class="button">Get Recommendations</button>
                        {% endif %}
                        <p>Note, recommendations take 20-25 seconds per user. After getting stats/users with the top button, recommendations will be pulled for users in the BCC list.</p>

                        <form method="POST" action="/send_email" style="margin-top: 0;">
                            Subject: <input type="text" name="subject" id="subject" placeholder="Subject"
                                value="{{ settings.server_name }} News" style="width: 18rem;" required><br><br>
                        </form>
                    </td>
                    <td style="width: 40%; padding: 10px; vertical-align: top; position: sticky; top: 80px;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Preview:</span>
                            <button id="popout-preview-btn" class="btn button-outline btn-sm" title="Open preview in new window">
                                🗗 Pop-out
                            </button>
                        </div>
                        <iframe class="frame" id="preview"></iframe>
                    </td>
                    <td style="width: 60%; padding: 10px; vertical-align: top;">
                        <!-- Selected Items Pane -->
                        <div id="selected-items-pane">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2>Snap-ins</h2>
                                <div class="d-flex gap-2 align-items-center">
                                    <button id="reset-template-btn" class="btn btn-outline-secondary btn-sm" title="Clear all items and reset to Custom template">
                                        🔄 Reset
                                    </button>
                                    <label for="template-selector" class="form-label mb-0">Template:</label>
                                    <select id="template-selector" class="form-select" style="width: 200px;">
                                        <option value="">Custom</option>
                                        <option value="save-template">(Save template)</option>
                                    </select>
                                    <button id="delete-template-btn" class="btn btn-outline-danger btn-sm" style="display: none;">
                                        🗑️ Delete
                                    </button>
                                </div>
                            </div>
                            <div id="selected-items-list" class="border rounded p-3 mb-4" style="min-height: 100px; background: #f8f9fa;">
                                <div id="selected-items-empty" class="text-muted text-center py-3">
                                    No items selected. Use the buttons below to add items to your email.
                                </div>
                            </div>
                        </div>

                        <!-- Text Blocks Section -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2>Text Blocks</h2>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="add-title-btn" title="Add a title block with large heading text">
                                        + Title
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="add-intro-btn" title="Add introduction text about server membership">
                                        + Intro
                                    </button>
                                    <button type="button" class="btn btn-primary btn-sm" id="add-text-block-btn">
                                        + Text Block
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="add-outro-btn" title="Add closing thank you message">
                                        + Outro
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Stats and Graphs side by side -->
                        <div class="row">
                            <!-- Available Stats Column -->
                            <div class="col-md-6">
                                {% if stats %}
                                    <h2>Available Stats</h2>
                                    <div class="row">
                                        {% for stat in stats %}
                                            <div class="col-12 mb-2">
                                                <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                                    <span style="font-size: 0.9rem;">{{ stat.stat_title }}</span>
                                                    <div>
                                                        <button type="button" class="btn button-outline btn-sm me-1 view-stat-btn" 
                                                                data-target="stat-{{ loop.index0 }}" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                                            View
                                                        </button>
                                                        <button type="button" class="btn button btn-sm add-stat-btn" 
                                                                data-id="stat-{{ loop.index0 }}" 
                                                                data-name="{{ stat.stat_title }}"
                                                                data-type="stat" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                                            Add
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Available Graphs Column -->
                            <div class="col-md-6">
                                <h2>Available Graphs</h2>
                                {% if graph_data != [{},{}] %}
                                    <div class="row">
                                        {% for graph in graph_data %}
                                            <div class="col-12 mb-2">
                                                <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                                    <span style="font-size: 0.9rem;">{{ graph_commands[loop.index0].name }}</span>
                                                    <div>
                                                        <button type="button" class="btn button-outline btn-sm me-1 view-graph-btn" 
                                                                data-target="graph-{{ loop.index0 }}" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                                            View
                                                        </button>
                                                        <button type="button" class="btn button btn-sm add-graph-btn" 
                                                                data-id="graph-{{ loop.index0 }}" 
                                                                data-name="{{ graph_commands[loop.index0].name }}"
                                                                data-type="graph" style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                                            Add
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-info" style="font-size: 0.9rem; padding: 0.75rem;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        No graph data available. Click <strong>"Get Stats\Users"</strong> to load data.
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Stats Preview -->
                        {% if stats %}
                            <div id="stat-preview" class="mt-3" style="display: none;">
                                {% for stat in stats %}
                                    <div id="stat-{{ loop.index0 }}" class="stat-table d-none">
                                    <div class="card my-4">
                                        <div class="card-header bg-primary text-white">
                                            {{ stat.stat_title }}
                                        </div>
                                        <div class="card-body blur-container p-0">
                                            {% if stat.rows %}
                                                {% if stat.rows[0].art != '' %}
                                                    <img src="/proxy-art{{ stat.rows[0].art }}" class="bg-blur" alt="" />
                                                {% elif stat.rows[0].grandparent_thumb != '' %}
                                                    <img src="/proxy-art{{ stat.rows[0].grandparent_thumb }}" class="bg-blur" alt="" />
                                                {% endif %}
                                                <table class="table table-striped content-table m-0">
                                                    {% if stat.stat_title == "Most Watched Movies" or stat.stat_title == "Most Watched TV Shows" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Title</th>
                                                                <th>Year</th>
                                                                <th>Plays</th>
                                                                <th>Hours Played</th>
                                                                <th>Rating</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Popular Movies" or stat.stat_title == "Most Popular TV Shows" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Title</th>
                                                                <th>Year</th>
                                                                <th>Plays</th>
                                                                <th>Users</th>
                                                                <th>Rating</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Played Artists" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Author</th>
                                                                <th>Year</th>
                                                                <th>Plays</th>
                                                                <th>Hours Played</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Popular Artists" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Author</th>
                                                                <th>Year</th>
                                                                <th>Plays</th>
                                                                <th>Users</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Recently Watched" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Title</th>
                                                                <th>Year</th>
                                                                <th>Rating</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Active Libraries" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Library</th>
                                                                <th>Plays</th>
                                                                <th>Hours Played</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Active Users" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Username</th>
                                                                <th>Plays</th>
                                                                <th>Hours Played</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Active Platforms" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Platform</th>
                                                                <th>Plays</th>
                                                                <th>Hours Played</th>
                                                            </tr>
                                                        </thead>
                                                    {% elif stat.stat_title == "Most Concurrent Streams" %}
                                                        <thead class="table-dark">
                                                            <tr>
                                                                <th>Category</th>
                                                                <th>Count</th>
                                                            </tr>
                                                        </thead>
                                                    {% endif %}
                                                    <tbody>
                                                        {% for row in stat.rows %}
                                                            <tr>
                                                                {% if stat.stat_title == "Most Active Libraries" %}
                                                                    <td>{{ row.section_name }}</td>
                                                                {% elif stat.stat_title == "Most Active Users" %}
                                                                    <td>{{ row.user }}</td>
                                                                {% elif stat.stat_title == "Most Active Platforms" %}
                                                                    <td>{{ row.platform }}</td>
                                                                {% else %}
                                                                    <td>{{ row.title }}</td>
                                                                {% endif %}

                                                                {% if stat.stat_title == "Most Active Libraries" or stat.stat_title == "Most Active Users" or stat.stat_title == "Most Active Platforms" or stat.stat_title == "Most Concurrent Streams" %}
                                                                {% else %}
                                                                    <td>{{ row.year }}</td>
                                                                {% endif %}

                                                                {% if "Recently" in stat.stat_title %}
                                                                {% elif "Concurrent" in stat.stat_title %}
                                                                {% else %}
                                                                    <td>{{ row.total_plays }}</td>
                                                                {% endif %}

                                                                {% if stat.stat_title == "Most Watched Movies" or stat.stat_title == "Most Watched TV Shows" or stat.stat_title == "Most Played Artists" or stat.stat_title == "Most Active Libraries" or stat.stat_title == "Most Active Users" or stat.stat_title == "Most Active Platforms" %}
                                                                    <td>{{ (row.total_duration / 3600) | round(0, 'ceil')  | int }}</td>
                                                                {% elif stat.stat_title == "Most Popular Movies" or stat.stat_title == "Most Popular TV Shows" or stat.stat_title == "Most Popular Artists" %}
                                                                    <td>{{ row.users_watched }}</td>
                                                                {% endif %}

                                                                {% if stat.stat_title == "Most Active Libraries" or stat.stat_title == "Most Played Artists" or stat.stat_title == "Most Popular Artists" or stat.stat_title == "Most Active Users" or stat.stat_title == "Most Active Platforms" or stat.stat_title == "Most Concurrent Streams" %}
                                                                {% else %}
                                                                    <td>{{ row.content_rating }}</td>
                                                                {% endif %}

                                                                {% if stat.stat_title == "Most Concurrent Streams" %}
                                                                    <td>{{ row.count }}</td>
                                                                {% endif %}
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            {% else %}
                                                <p class="m-3">No data available.</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}

                        <!-- Graphs Preview -->
                        {% if graph_data != [{},{}] %}
                            <div id="graph-preview" class="mt-3" style="display: none;">
                                {% for graph in graph_data %}
                                    <div class="graph-table d-none" id="graph-{{ loop.index0 }}"></div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </td>
                </tr>
            </table>
            <section>
                <div class="flex items-end justify-between gap-3 mb-6">
                    <h2>Recently Added</h2>
                    <select id="ra-lib" class="border rounded px-3 py-2 dark:bg-[#333]">
                        <option value="" selected>Select A Library...</option>
                        <option value="__ALL__">All Libraries</option>
                    </select>
                </div>

                <ul id="ra-grid" class="grid grid-cols-10 gap-4" style="padding-right: 2rem;"></ul>

                <div id="ra-empty" class="hidden text-center text-gray-500 dark:text-gray-400 mt-10">
                    No items match your filters.
                </div>
            </section><br>
            <section>
                <div id="recommendations_pane">
                </div>
            </section>
        </div>
        <script>
            const recentPayload = {{ recent_data | tojson }};

            function buildThumb(path) {
                if (!path) return '';
                const p = path.startsWith('/') ? path : '/' + path;
                return `/proxy-art${p}`;
            }

            function pickThumb(it) {
                const type = (it.media_type || it.type || '').toLowerCase();

                const candidates = (type === 'episode' || type === 'season')
                    ? [it.grandparent_thumb, it.parent_thumb, it.thumb, it.art]
                    : [it.thumb, it.art, it.parent_thumb, it.grandparent_thumb];

                return candidates.find(Boolean) || '';
            }

            const flatten = (arr) => arr.flatMap(x => x?.recently_added || []);
            const msToHMS = (ms) => {
                ms = parseInt(ms || 0, 10);
                const s = Math.round(ms / 1000);
                const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
                return h ? `${h}h ${m}m` : `${m}m`;
            };
            const formatDate = (d) => {
                if (!d) return '';
                if (/^\d+$/.test(String(d))) return new Date(parseInt(d,10)*1000).toLocaleDateString();
                const dt = new Date(d); return isNaN(dt) ? '' : dt.toLocaleDateString();
            };

            const items = flatten(recentPayload).map(it => {
                const title = it.title || it.full_title || it.parent_title || it.grandparent_title || '(untitled)';
                const sub = it.year || it.grandparent_title || it.parent_title || '';
                const thumbPath = pickThumb(it);
                return {
                    library: it.library_name || it.section_name || '',
                    title,
                    sub,
                    summary: it.tagline || it.summary || '',
                    duration: msToHMS(it.duration),
                    added: formatDate(it.added_at || it.originally_available_at),
                    thumb: thumbPath
                };
            });

            const libSel = document.getElementById('ra-lib');
            [...new Set(items.map(i => i.library).filter(Boolean))].sort().forEach(lib => {
                const opt = document.createElement('option');
                opt.value = lib; opt.textContent = lib;
                libSel.appendChild(opt);
            });

            const grid = document.getElementById('ra-grid');
            const empty = document.getElementById('ra-empty');

            function render(list) {
                grid.innerHTML = '';
                list.forEach(it => {
                    const imgURL = buildThumb(it.thumb);
                    const li = document.createElement('li');
                    li.className = "group rounded-2xl overflow-hidden bg-[#8acbd4] dark:bg-[#333] " + 
                    "!shadow-[0_6px_18px_rgba(0,0,0,0.6)] hover:!shadow-[0_10px_28px_rgba(0,0,0,0.6)] " + 
                    "dark:!shadow-[0_6px_18px_rgba(74,127,130,0.6)] dark:hover:!shadow-[0_10px_28px_rgba(74,127,130,0.6)]";
                    li.dataset.lib = it.library;
                    li.innerHTML = `
                        <style>
                            .ra-pill{ display:inline-flex; align-items:center; justify-content:center; line-height:1; }
                        </style>
                        <div class="relative aspect-[2/3] bg-gray-200 dark:bg-gray-700">
                            ${imgURL ? `<img loading="lazy" src="${imgURL}" class="h-full w-full object-cover">` : ''}
                            ${it.library ? `<div class="ra-pill absolute top-1 right-1 text-xs px-2 py-1 rounded-full bg-black/70 text-white"><span class="pill_text">${it.library}</span></div>` : ''}
                            ${it.added ? `<div class="ra-pill absolute bottom-1 right-1 text-[11px] text-white/90 bg-black/60 rounded px-1.5 py-0.5"><span class="pill_text">${it.added}</span></div>` : ''}
                        </div>
                        <div class="p-3">
                            <div class="font-semibold line-clamp-2">${it.title}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                ${it.sub ? it.sub + ' • ' : ''}${it.duration}
                            </div>
                            ${it.summary ? `<div class="mt-2 text-xs text-gray-600 dark:text-gray-300 line-clamp-5">${it.summary}</div>` : ''}
                        </div>
                    `;
                    grid.appendChild(li);
                });
                empty.classList.toggle('hidden', list.length !== 0);
            }

            function applyFilter() {
                const lb = libSel.value;
                if (lb === '') { render([], { showEmpty:false }); return; }
                if (lb === '__ALL__') { render(items); return; }
                render(items.filter(it => it.library === lb));
            }

            libSel.addEventListener('input', applyFilter);
        </script>
        <script>
            document.getElementById('time_range_week').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 7;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_month').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 30;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_quarter').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 90;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_two_q').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 180;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_three_q').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 270;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
            document.getElementById('time_range_year').addEventListener('click', () => {
                document.getElementById('days_to_pull').value = 365;
                showSpinner('Getting stats and users...');
                document.getElementById('stats_form').submit();
            });
        </script>
        <script>
            async function waitForImages(scope){
                const imgs = Array.from(scope.querySelectorAll('img'));
                await Promise.all(imgs.map(img => img.complete ? 0 : new Promise(res=>{
                    img.addEventListener('load', res, {once:true});
                    img.addEventListener('error', res, {once:true});
                })));
                try { await document.fonts?.ready; } catch(_){}
            }

            async function captureRecentlyAddedPNG() {
                const grid = document.getElementById('ra-grid');
                if (!grid || !grid.children.length) return null;

                const rect = grid.getBoundingClientRect();
                if (!rect.width || !rect.height) return null;

                await waitForImages(grid);

                const bg = '#282A2D';

                function renderPass(useFO){
                    return html2canvas(grid, {
                        useCORS: true,
                        backgroundColor: bg,
                        scale: window.devicePixelRatio > 1 ? 2 : 1,
                        foreignObjectRendering: useFO,
                        windowWidth: grid.scrollWidth,
                        windowHeight: grid.scrollHeight,
                        onclone: (doc) => {
                            const g = doc.getElementById('ra-grid');
                            if (!g) return;

                            const kill = doc.createElement('style');
                            kill.textContent = `
                                *{ box-shadow: none !important; filter: none !important; }
                                [class*="shadow"]{ box-shadow: none !important; }
                                [style*="box-shadow"]{ box-shadow: none !important; }
                            `;
                            doc.head.appendChild(kill);

                            g.querySelectorAll('*').forEach(el => {
                                if (typeof el.className === 'string' && el.className.includes('shadow')) {
                                    el.className = el.className.split(/\s+/).filter(t => !/shadow/i.test(t)).join(' ');
                                }
                            });

                            g.querySelectorAll('.aspect-\\[2\\/3\\]').forEach(el => {
                                const w = el.getBoundingClientRect().width || el.clientWidth || 0;
                                if (w > 0) el.style.height = Math.round(w * 3 / 2) + 'px';
                            });

                            const pillNodes = g.querySelectorAll(
                                '.absolute.top-1.right-1, .absolute.bottom-1.right-1 span, .ra-pill'
                            );
                            pillNodes.forEach(p => {
                                p.style.display = 'inline-flex';
                                p.style.alignItems = 'center';
                                p.style.justifyContent = 'center';
                                p.style.lineHeight = '1';
                                if (!p.style.padding) p.style.padding = '2px 6px';
                                p.style.minHeight = '18px';
                                p.style.borderRadius = '9999px';
                                const cs = doc.defaultView.getComputedStyle(p);
                                
                            });

                            g.querySelectorAll('.pill_text').forEach(s => {
                                s.style.position = 'relative'
                                s.style.top = '-6px';
                            });

                            g.querySelectorAll('.font-semibold.line-clamp-2').forEach(el => {
                                el.style.display = 'block';
                                el.style.webkitLineClamp = 'unset';
                                el.style.overflow = 'hidden';
                                el.style.lineHeight = '1.5';
                                el.style.maxHeight   = (1.75 * 2) + 'em';
                                el.style.paddingBottom = '3px';
                            });

                            g.querySelectorAll('.p-3 > .text-xs:first-of-type').forEach(el => {
                                el.style.lineHeight = '1.75';
                                el.style.paddingBottom = '1px';
                            });

                            g.querySelectorAll('.line-clamp-5').forEach(el => {
                                el.style.display = 'block';
                                el.style.webkitLineClamp = 'unset';
                                el.style.overflow = 'hidden';
                                el.style.lineHeight = '1.4';
                                el.style.maxHeight   = (1.5 * 5) + 'em';
                                el.style.paddingBottom = '4px';
                            });

                            g.querySelectorAll('.p-3').forEach(c => {
                                const cs = doc.defaultView.getComputedStyle(c);
                                const pb = parseFloat(cs.paddingBottom) || 0;
                                if (pb < 8) c.style.paddingBottom = '8px';
                            });

                            g.querySelectorAll('ul').forEach(u => { u.style.margin = '0'; u.style.padding = '0'; });
                        }
                    });
                }

                let canvas = await renderPass(false);
                if (!canvas || !canvas.width || !canvas.height) {
                    canvas = await renderPass(true);
                }
                if (!canvas || !canvas.width || !canvas.height) return null;

                const blob = await new Promise(r => canvas.toBlob(r, 'image/png', 0.92));
                const dataUrl = canvas.toDataURL('image/png', 0.92);
                return { blob, dataUrl, cid: 'recently-added.png' };
            }
        </script>
        <script>
            async function waitImagesAndFonts(scope){
                const imgs = Array.from(scope.querySelectorAll('img'));
                await Promise.all(imgs.map(img => img.complete ? 0 : new Promise(res=>{
                    img.addEventListener('load', res, {once:true});
                    img.addEventListener('error', res, {once:true});
                })));
                try { await document.fonts?.ready; } catch(_) {}
            }

            async function captureRecommendationsPNG() {
                const grid = document.getElementById('rec-grid');
                if (!grid || !grid.children.length) return null;

                const rect = grid.getBoundingClientRect();
                if (!rect.width || !rect.height) return null;

                await waitImagesAndFonts(grid);

                const bg = '#282A2D';

                function renderPass(useFO){
                    return html2canvas(grid, {
                        useCORS: true,
                        backgroundColor: bg,
                        scale: window.devicePixelRatio > 1 ? 2 : 1,
                        foreignObjectRendering: useFO,
                        windowWidth: grid.scrollWidth,
                        windowHeight: grid.scrollHeight,
                        onclone: (doc) => {
                            const g = doc.getElementById('rec-grid');
                            if (!g) return;

                            g.querySelectorAll('.pill_text').forEach(s => {
                                s.style.position = 'relative'
                                s.style.top = '-6px';
                            });

                            g.querySelectorAll('img').forEach(img => {
                                const src = img.getAttribute('src') || '';
                                if (/^https?:/i.test(src)) {
                                    img.setAttribute('crossorigin', 'anonymous');
                                    img.setAttribute('src', `/proxy-img?u=${encodeURIComponent(src)}`);
                                }
                            });

                            const kill = doc.createElement('style');
                            kill.textContent = `
                                *{ box-shadow:none !important; filter:none !important; }
                                [class*="shadow"]{ box-shadow:none !important; }
                                [style*="box-shadow"]{ box-shadow:none !important; }
                            `;
                            doc.head.appendChild(kill);

                            g.querySelectorAll('.aspect-\\[2\\/3\\]').forEach(el => {
                                const w = el.getBoundingClientRect().width || el.clientWidth || 0;
                                if (w > 0) el.style.height = Math.round(w * 3 / 2) + 'px';
                            });

                            g.querySelectorAll('.absolute.top-1.right-1, .absolute.bottom-1.right-1 span, .ra-pill')
                            .forEach(p => {
                                p.style.display = 'inline-flex';
                                p.style.alignItems = 'center';
                                p.style.justifyContent = 'center';
                                p.style.lineHeight = '1';
                                if (!p.style.padding) p.style.padding = '2px 6px';
                                p.style.minHeight = '18px';
                                p.style.borderRadius = '9999px';
                            });

                            g.querySelectorAll('.font-semibold.line-clamp-2').forEach(el => {
                                el.style.display = 'block';
                                el.style.webkitLineClamp = 'unset';
                                el.style.overflow = 'hidden';
                                el.style.lineHeight = '1.5';
                                el.style.maxHeight   = (1.75 * 2) + 'em';
                                el.style.paddingBottom = '3px';
                            });
                            g.querySelectorAll('.line-clamp-5').forEach(el => {
                                el.style.display = 'block';
                                el.style.webkitLineClamp = 'unset';
                                el.style.overflow = 'hidden';
                                el.style.lineHeight = '1.4';
                                el.style.maxHeight   = (1.5 * 5) + 'em';
                                el.style.paddingBottom = '4px';
                            });

                            g.querySelectorAll('ul').forEach(u => { u.style.margin='0'; u.style.padding='0'; });
                        }
                    });
                }

                let canvas = await renderPass(false);
                if (!canvas || !canvas.width || !canvas.height) canvas = await renderPass(true);
                if (!canvas || !canvas.width || !canvas.height) return null;

                const blob = await new Promise(r => canvas.toBlob(r, 'image/png', 0.92));
                const dataUrl = canvas.toDataURL('image/png', 0.92);
                return { blob, dataUrl, cid: 'recommendations.png' };
            }
        </script>
        <script>
            // Global variable for selected items
            let selectedItems = [];

            async function insertRecentlyAddedIntoPreview(html) {
                const ra = await captureRecentlyAddedPNG();
                if (!ra) return html.replace('[RECENTLY_ADDED]', '');
                return html.replace(
                    '[RECENTLY_ADDED]',
                    `<img src="${ra.dataUrl}" alt="Recently Added" style="max-width:100%;height:auto;border-radius:5px;display:block;">`
                );
            }

            async function insertRecommendationsIntoPreview(html) {
                const rec = await captureRecommendationsPNG();
                if (!rec) return html.replace('[RECOMMENDATIONS]', '');
                return html.replace(
                    '[RECOMMENDATIONS]',
                    `<img src="${rec.dataUrl}" alt="Recommendations" style="max-width:100%;height:auto;border-radius:5px;display:block;">`
                );
            }

            async function updatePreview() {
                try {
                    console.log('updatePreview called with selectedItems:', selectedItems);
                    
                    // Safety check
                    if (typeof selectedItems === 'undefined') {
                        console.error('selectedItems is undefined in updatePreview');
                        return;
                    }
                    
                    // Process all items in order to build the complete content
                    const serverName = "{{ settings.server_name }}";
                    const subject = document.getElementById('subject').value;
                    const isDark = document.documentElement.classList.contains('dark');

                    console.log('Server name:', serverName);
                    console.log('Subject:', subject);

                    let html = "";
                    let displaySubject = subject.startsWith(serverName) 
                        ? subject.slice(serverName.length).trimStart()
                        : subject;

                    const selectedGraphs = selectedItems.filter(item => item.type === 'graph').map(item => item.id);
                    const selectedStats = selectedItems.filter(item => item.type === 'stat').map(item => item.id);
                    
                    console.log('selectedGraphs:', selectedGraphs);
                    console.log('selectedStats:', selectedStats);

                let allItemsHTML = "";
                let insertedBreakBeforeStats = false;
                
                // Process ALL items in the exact order they appear in selectedItems array
                for (let item of selectedItems) {
                    if (item.type === 'textblock') {
                        // Add text block content directly to the HTML stream
                        const content = getTextBlockContent(item.id);
                        if (content && content.trim().length > 0) {
                            const formattedContent = content.trim().replace(/\n/g, "<br>");
                            allItemsHTML += `<div style="margin-bottom: 15px;">${formattedContent}</div>`;
                        }
                    } else if (item.type === 'titleblock') {
                        // Add title block with larger styling
                        const content = getTextBlockContent(item.id);
                        if (content && content.trim().length > 0) {
                            const formattedContent = content.trim().replace(/\n/g, "<br>");
                            allItemsHTML += `<div style="margin-bottom: 20px; font-size: 1.5em; font-weight: bold; text-align: center;">${formattedContent}</div>`;
                        }
                    } else if (item.type === 'graph') {
                        const chart = Highcharts.charts.find(c => c && c.renderTo.id === item.id);
                        if (chart) {
                            try {
                                const svg = chart.getSVG();
                                const canvas = document.createElement("canvas");
                                const ctx = canvas.getContext("2d");
                                const img = new Image();

                                await new Promise((resolve, reject) => {
                                    img.onload = () => {
                                        canvas.width = img.width;
                                        canvas.height = img.height;
                                        ctx.drawImage(img, 0, 0);
                                        const dataUrl = canvas.toDataURL("image/png");
                                        allItemsHTML += `<img src="${dataUrl}" style="max-width: 100%; margin-bottom: 10px;">`;
                                        resolve();
                                    };
                                    img.onerror = (error) => {
                                        console.warn('Failed to load graph image for', item.id, error);
                                        resolve(); // Don't reject, just skip this graph
                                    };
                                    img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
                                });
                            } catch (error) {
                                console.warn('Error processing graph', item.id, error);
                            }
                        }
                    } else if (item.type === 'stat') {
                        if (!insertedBreakBeforeStats) {
                            allItemsHTML += `<div style="height:16px;line-height:16px;font-size:16px">&nbsp;</div>`;
                            insertedBreakBeforeStats = true;
                        }
                        const tableElement = document.getElementById(item.id);
                        if (tableElement) {
                            try {
                                const wasHidden = tableElement.classList.contains('d-none');
                                if (wasHidden) {
                                    tableElement.classList.remove('d-none');
                                }
                                await new Promise(resolve => setTimeout(resolve, 150));

                                const original = document.getElementById(item.id);
                                if (!original) continue;

                                const clone = original.cloneNode(true);
                                const tempWrapper = document.createElement('div');

                                clone.style.display = 'inline-block';
                                clone.style.width = 'auto';

                                const table = clone.querySelector('.content-table');
                                if (table) {
                                    table.style.width = 'auto';
                                }

                                tempWrapper.style.position = 'fixed';
                                tempWrapper.style.top = '-10000px';
                                tempWrapper.style.left = '0';
                                tempWrapper.style.zIndex = '-1';
                                tempWrapper.style.overflow = 'hidden';
                                tempWrapper.appendChild(clone);
                                document.body.appendChild(tempWrapper);

                                const blurImage = clone.querySelector('.bg-blur');
                                if (blurImage) {
                                    await blurImageElement(blurImage);
                                }

                                await new Promise(resolve => setTimeout(resolve, 50));
                                
                                const canvas = await html2canvas(clone, {
                                    backgroundColor: null,
                                    scale: 1,
                                    useCORS: true
                                });

                                const dataUrl = canvas.toDataURL("image/png");
                                allItemsHTML += `<img src="${dataUrl}" style="max-width: 100%; margin-bottom: 10px;">`;

                                document.body.removeChild(tempWrapper);

                                if (wasHidden) {
                                    tableElement.classList.add('d-none');
                                }
                            } catch (error) {
                                console.warn('Error processing stat', item.id, error);
                                // Clean up if something went wrong
                                try {
                                    if (document.body.contains(tempWrapper)) {
                                        document.body.removeChild(tempWrapper);
                                    }
                                    if (wasHidden && tableElement) {
                                        tableElement.classList.add('d-none');
                                    }
                                } catch (cleanupError) {
                                    console.warn('Error during stat cleanup', cleanupError);
                                }
                            }
                        }
                    }
                }

                // Now allItemsHTML contains all content in the correct order
                // Use the content directly with the standard layout
                let content = allItemsHTML || "";

                html = `
                        <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,500,600,700&display=swap" rel="stylesheet">
                        <style>
                            :root { color-scheme: ${isDark ? 'dark' : 'light'}; }
                            html, body { background: ${isDark ? '#333' : '#8acbd4'}; }
                        </style>
                        <html><body style="font-family: IBM Plex Sans; margin: 0;">
                            <table class="body" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%;" border="0" cellspacing="0" cellpadding="0">
                                <tbody>
                                    <tr>
                                        <td class="preview-container" style="font-family: IBM Plex Sans; font-size: 14px; vertical-align: top; display: block;">
                                            <div class="content" style="box-sizing: border-box; display: block;"><span class="preheader" style="color: transparent; display: none; height: 0; max-height: 0; max-width: 0; opacity: 0; overflow: hidden; mso-hide: all; visibility: hidden; width: 0;">${serverName} Newsletter</span>
                                                <table class="main" style="border-collapse: separate; mso-table-lspace: 0pt; mso-table-rspace: 0pt; width: 100%; background: #282A2D; border-radius: 3px; color: #ffffff;" border="0" cellspacing="0" cellpadding="3">
                                                    <tbody>
                                                        <tr>
                                                            <td class="wrapper" style="font-family: IBM Plex Sans; font-size: 14px; vertical-align: top; box-sizing: border-box; padding: 5px; overflow: auto;">
                                                                <div class="header" style="width: 50%; height: 10px; text-align: center;"><img class="header-img" style="border: none; -ms-interpolation-mode: bicubic; max-width: 9%; width: 492px; height: 20px; margin-left: -35px;" src="https://d15k2d11r6t6rl.cloudfront.net/public/users/Integrators/669d5713-9b6a-46bb-bd7e-c542cff6dd6a/3bef3c50f13f4320a9e31b8be79c6ad2/Plex%20Logo%20Update%202022/plex-logo-heavy-stroke.png" width="492" height="90" /></div>
                                                                <div class="server-name" style="font-size: 25px; text-align: center; margin-bottom: 0;">${serverName} Newsletter</div>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td class="footer" style="font-family: IBM Plex Sans; font-size: 12px; vertical-align: top; clear: both; margin-top: 0; text-align: center; width: 100%;">

                                                                <h1 class="footer-bar" style="margin-left: auto; margin-right: auto; width: 300px; border-top: 1px solid #E5A00D; margin-top: 5px;">${displaySubject}</h1>
                                                                <p style="margin: 20px 0;">
                                                                    ${content}
                                                                </p>
                                                                <div class="footer-bar" style="margin-left: auto; margin-right: auto; width: 250px; border-top: 1px solid #E5A00D; margin-top: 25px;">&nbsp;</div>
                                                                <div class="content-block powered-by" style="padding-bottom: 10px; padding-top: 0;">Generated for Plex Media Server by <a href="https://github.com/jma1ice/newsletterr" style="color: #E5A00D; text-decoration: none;">newsletterr</a></div>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table></body></html>`;
                html = await insertRecentlyAddedIntoPreview(html);
                html = await insertRecommendationsIntoPreview(html);

                const frame = document.getElementById('preview');
                console.log('Frame element:', frame);
                if (!frame) {
                    console.error('Preview iframe not found!');
                    return;
                }
                
                console.log('HTML content length:', html.length);
                console.log('HTML content preview:', html.substring(0, 200) + '...');
                
                // Set the HTML content first
                frame.srcdoc = html;
                
                // Function to auto-resize iframe based on content
                function resizeIframe() {
                    try {
                        const doc = frame.contentDocument || frame.contentWindow.document;
                        if (doc && doc.body) {
                            const contentHeight = Math.max(
                                doc.body.scrollHeight,
                                doc.body.offsetHeight,
                                doc.documentElement.clientHeight,
                                doc.documentElement.scrollHeight,
                                doc.documentElement.offsetHeight
                            );
                            
                            // Apply min and max height constraints
                            const minHeight = 480; // 30rem in pixels (assuming 16px base)
                            const maxHeight = 960; // 60rem in pixels
                            const newHeight = Math.max(minHeight, Math.min(maxHeight, contentHeight + 20)); // +20 for padding
                            
                            frame.style.height = newHeight + 'px';
                            console.log('Iframe resized to:', newHeight + 'px', 'Content height:', contentHeight);
                        }
                    } catch (e) {
                        console.log('Could not resize iframe:', e);
                    }
                }
                
                // Wait for the iframe to load, then apply dark mode and resize
                frame.onload = function() {
                    try {
                        const doc = frame.contentDocument || frame.contentWindow.document;
                        if (doc && doc.documentElement) {
                            if (isDark) {
                                doc.documentElement.classList.add('dark');
                            }
                            // Resize after a short delay to ensure content is fully rendered
                            setTimeout(resizeIframe, 100);
                        }
                    } catch (e) {
                        console.log('Could not apply dark mode or resize iframe:', e);
                    }
                };
                
                console.log('Preview updated successfully');
                } catch (error) {
                    console.error('Error in updatePreview:', error);
                    console.error('Error stack:', error.stack);
                    // Don't let the error break the preview - show something basic
                    const frame = document.getElementById('preview');
                    if (frame) {
                        frame.srcdoc = `<html><body><p>Error updating preview: ${error.message}</p><p>Check console for details</p></body></html>`;
                    }
                }
            }

            // Debounce function to limit how often updatePreview is called
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Create debounced version of updatePreview (wait 300ms after user stops typing)
            const debouncedUpdatePreview = debounce(updatePreview, 300);

            document.addEventListener('DOMContentLoaded', () => {
                // Use debounced version for text input to prevent excessive calls
                document.getElementById('email_text').addEventListener('input', debouncedUpdatePreview);
                
                // Test preview on load
                console.log('DOM loaded, testing preview...');
                const frame = document.getElementById('preview');
                if (frame) {
                    frame.srcdoc = '<html><body><h1>Test Preview</h1><p>If you can see this, the iframe is working.</p></body></html>';
                    console.log('Test preview set');
                } else {
                    console.error('Preview iframe not found on DOM load!');
                }
                
                // Also run initial preview update
                setTimeout(() => {
                    console.log('Running initial updatePreview...');
                    updatePreview();
                }, 100);
            });
        </script>
        <script>
            // Handle stat view buttons
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-stat-btn')) {
                    const targetId = e.target.dataset.target;
                    const previewDiv = document.getElementById('stat-preview');
                    const allStats = document.querySelectorAll('.stat-table');
                    
                    // Hide all stats
                    allStats.forEach(el => el.classList.add('d-none'));
                    
                    // Show selected stat
                    document.getElementById(targetId).classList.remove('d-none');
                    previewDiv.style.display = 'block';
                }
                
                if (e.target.classList.contains('view-graph-btn')) {
                    const targetId = e.target.dataset.target;
                    const previewDiv = document.getElementById('graph-preview');
                    const allGraphs = document.querySelectorAll('.graph-table');
                    
                    // Hide all graphs
                    allGraphs.forEach(el => el.classList.add('d-none'));
                    
                    // Show selected graph and render it if not already rendered
                    const container = document.getElementById(targetId);
                    container.classList.remove('d-none');
                    previewDiv.style.display = 'block';
                    
                    // Render chart if not already rendered
                    if (!renderedCharts.has(targetId)) {
                        const index = parseInt(targetId.split('-')[1]);
                        const graphData = graphDataList[index];

                        Highcharts.chart(targetId, {
                            chart: { type: 'line' },
                            title: { text: graphCommands[index].name },
                            exporting: {
                                enabled: true
                            },
                            xAxis: { categories: graphData.categories },
                            yAxis: { title: { text: 'Plays' } },
                            series: graphData.series
                        });

                        renderedCharts.add(targetId);
                    }
                    
                    const nowDark = document.documentElement.classList.contains('dark');
                    applyChartTheme(nowDark);
                }
            });
        </script>
        <script>
            function themeVars(isDark) {
                return {
                    text: isDark ? '#8acbd4' : '#333',
                    grid: isDark ? '#e5e7eb' : '#374151',
                    axis: isDark ? '#e5e7eb' : '#374151',
                    bg: isDark ? '#333' : '#8acbd4',
                };
            }

            function applyChartTheme(isDark) {
                const t = themeVars(isDark);

                Highcharts.setOptions({
                    chart: { backgroundColor: t.bg, style: { fontFamily: 'IBM Plex Sans' } },
                    title: { style: { color: t.text } },
                    legend: { itemStyle: { color: t.text } },
                    xAxis: { labels: { style: { color: t.text } }, gridLineColor: t.grid, lineColor: t.axis, tickColor: t.axis },
                    yAxis: { labels: { style: { color: t.text } }, title: { style: { color: t.text } }, gridLineColor: t.grid, lineColor: t.axis, tickColor: t.axis }
                });

                Highcharts.charts.filter(Boolean).forEach(c => {
                    c.update({
                        chart: { backgroundColor: t.bg },
                        title: { style: { color: t.text } },
                        legend: { itemStyle: { color: t.text } }
                    });

                    c.xAxis.forEach(ax => ax.update({
                        labels: { style: { color: t.text } },
                        gridLineColor: t.grid,
                        lineColor: t.axis,
                        tickColor: t.axis
                    }));

                    c.yAxis.forEach(ax => ax.update({
                        labels: { style: { color: t.text } },
                        title: { style: { color: t.text } },
                        gridLineColor: t.grid,
                        lineColor: t.axis,
                        tickColor: t.axis
                    }));

                    c.redraw();
                });
            }

            const isDark = document.documentElement.classList.contains('dark');
            applyChartTheme(isDark);

            document.getElementById('theme-toggle')?.addEventListener('click', () => {
                const nowDark = document.documentElement.classList.contains('dark');
                applyChartTheme(!nowDark);
            });

            const graphDataList = {{ graph_data | tojson }};
            const graphCommands = {{ graph_commands | tojson }};

            const renderedCharts = new Set();

            document.getElementById('graphSelector').addEventListener('change', function () {
                const selectedId = this.value;

                document.querySelectorAll('.graph-table').forEach(el => el.classList.add('d-none'));

                const container = document.getElementById(selectedId);
                container.classList.remove('d-none');

                if (!renderedCharts.has(selectedId)) {
                    const index = parseInt(selectedId.split('-')[1]);
                    const graphData = graphDataList[index];

                    Highcharts.chart(selectedId, {
                        chart: { type: 'line' },
                        title: { text: graphCommands[index].name },
                        exporting: {
                            enabled: true
                        },
                        xAxis: { categories: graphData.categories },
                        yAxis: { title: { text: 'Plays' } },
                        series: graphData.series
                    });

                    renderedCharts.add(selectedId);
                }

                const nowDark = document.documentElement.classList.contains('dark');
                applyChartTheme(nowDark);
            });
        </script>
        <script>
            // Selected Items Management
            function updateSelectedItemsDisplay() {
                const container = document.getElementById('selected-items-list');
                
                if (selectedItems.length === 0) {
                    container.innerHTML = '<div id="selected-items-empty" class="text-muted text-center py-3">No items selected. Use the buttons below to add items to your email.</div>';
                } else {
                    // Build HTML for all items in the exact order they appear in selectedItems
                    let htmlContent = '';
                    
                    selectedItems.forEach((item, index) => {
                        if (item.type === 'textblock' || item.type === 'titleblock') {
                            // Store the current content before rebuilding
                            const currentContent = getTextBlockContent(item.id) || '';
                            const badgeStyle = item.type === 'titleblock' ? 'badge-warning' : 'badge-secondary';
                            const placeholderText = item.type === 'titleblock' ? 'Enter your title here...' : 'Enter your text here...';
                            htmlContent += `
                                <div class="selected-item d-flex flex-column p-2 mb-2 border rounded bg-light" 
                                     data-index="${index}" draggable="true">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="item-name">${item.name}</span>
                                        <div>
                                            <span class="badge ${badgeStyle} me-2">${item.type}</span>
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" data-index="${index}">×</button>
                                        </div>
                                    </div>
                                    <textarea 
                                        data-textblock-id="${item.id}" 
                                        class="form-control text-block-editor" 
                                        style="height: 60px; font-size: 0.9rem; resize: vertical;"
                                        placeholder="${placeholderText}"
                                        oninput="updateTextBlockName('${item.id}', ${index})">${currentContent}</textarea>
                                </div>
                            `;
                        } else {
                            htmlContent += `
                                <div class="selected-item d-flex justify-content-between align-items-center p-2 mb-2 border rounded bg-light" 
                                     data-index="${index}" draggable="true" style="padding-left: 32px !important;">
                                    <span class="item-name">${item.name}</span>
                                    <div>
                                        <span class="badge badge-secondary me-2">${item.type}</span>
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn" data-index="${index}">×</button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    container.innerHTML = htmlContent;
                    
                    // Add drag and drop functionality
                    setupDragAndDrop();
                }
                
                // Update preview
                updatePreview();
            }

            function addItem(id, name, type) {
                // Check if item already exists
                if (selectedItems.find(item => item.id === id)) {
                    return false;
                }
                
                // If adding a graph, ensure it's rendered first
                if (type === 'graph' && !renderedCharts.has(id)) {
                    try {
                        const index = parseInt(id.split('-')[1]);
                        const graphData = graphDataList[index];

                        Highcharts.chart(id, {
                            chart: { type: 'line' },
                            title: { text: graphCommands[index].name },
                            exporting: {
                                enabled: true
                            },
                            xAxis: { categories: graphData.categories },
                            yAxis: { title: { text: 'Plays' } },
                            series: graphData.series
                        });

                        renderedCharts.add(id);
                        
                        // Apply current theme
                        const nowDark = document.documentElement.classList.contains('dark');
                        applyChartTheme(nowDark);
                        
                        console.log('Auto-rendered graph:', id);
                    } catch (error) {
                        console.warn('Failed to auto-render graph', id, error);
                    }
                }
                
                selectedItems.push({ id, name, type });
                updateSelectedItemsDisplay();
                return true;
            }

            function removeItem(index) {
                const removedItem = selectedItems[index];
                selectedItems.splice(index, 1);
                updateSelectedItemsDisplay();
                
                // Reset button state
                const button = document.querySelector(`[data-id="${removedItem.id}"]`);
                if (button) {
                    button.textContent = `Add`;
                    button.classList.remove('btn-success');
                    button.classList.add('button');
                    button.disabled = false;
                }
            }

            function setupDragAndDrop() {
                const items = document.querySelectorAll('.selected-item');
                let draggedElement = null;
                
                items.forEach((item, index) => {
                    item.addEventListener('dragstart', (e) => {
                        draggedElement = item;
                        e.dataTransfer.setData('text/plain', index);
                        e.dataTransfer.effectAllowed = 'move';
                        
                        // Add dragging class with a small delay for smooth transition
                        setTimeout(() => {
                            item.classList.add('dragging');
                        }, 0);
                    });
                    
                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                        // Remove drag-over class from all items
                        items.forEach(i => i.classList.remove('drag-over'));
                        draggedElement = null;
                    });
                    
                    item.addEventListener('dragenter', (e) => {
                        e.preventDefault();
                        if (draggedElement && draggedElement !== item) {
                            item.classList.add('drag-over');
                        }
                    });
                    
                    item.addEventListener('dragleave', (e) => {
                        // Only remove drag-over if we're actually leaving the element
                        if (!item.contains(e.relatedTarget)) {
                            item.classList.remove('drag-over');
                        }
                    });
                    
                    item.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                    });
                    
                    item.addEventListener('drop', (e) => {
                        e.preventDefault();
                        item.classList.remove('drag-over');
                        
                        const draggedIndex = parseInt(e.dataTransfer.getData('text/plain'));
                        const targetIndex = parseInt(item.dataset.index);
                        
                        if (draggedIndex !== targetIndex) {
                            // Reorder items
                            const draggedItem = selectedItems[draggedIndex];
                            selectedItems.splice(draggedIndex, 1);
                            selectedItems.splice(targetIndex, 0, draggedItem);
                            updateSelectedItemsDisplay();
                        }
                    });
                });
            }

            // Text Block functionality
            let textBlockCounter = 0;
            let titleBlockCounter = 0;
            
            function createTextBlock() {
                textBlockCounter++;
                const textBlockId = `text-block-${textBlockCounter}`;
                const textContent = '';
                const displayName = 'New text block';
                
                if (addItem(textBlockId, displayName, 'textblock')) {
                    return textBlockId;
                }
                return null;
            }
            
            function getTextBlockContent(textBlockId) {
                const textarea = document.querySelector(`[data-textblock-id="${textBlockId}"]`);
                return textarea ? textarea.value : '';
            }
            
            function setTextBlockContent(textBlockId, content) {
                const textarea = document.querySelector(`[data-textblock-id="${textBlockId}"]`);
                if (textarea) {
                    textarea.value = content;
                    // Update the display name after setting content
                    const index = selectedItems.findIndex(item => item.id === textBlockId);
                    if (index !== -1) {
                        selectedItems[index].name = getTextBlockDisplayName(content);
                        // Update the UI name display without triggering updateSelectedItemsDisplay
                        const nameSpan = document.querySelector(`[data-index="${index}"] .item-name`);
                        if (nameSpan) {
                            nameSpan.textContent = selectedItems[index].name;
                        }
                    }
                }
            }
            
            function getTextBlockDisplayName(content) {
                const firstLine = content.split('\n')[0].trim();
                if (firstLine.length === 0) return 'Empty text block';
                return firstLine.length > 30 ? firstLine.substring(0, 30) + '...' : firstLine;
            }
            
            function updateTextBlockName(textBlockId, index) {
                const content = getTextBlockContent(textBlockId);
                const newName = getTextBlockDisplayName(content);
                
                // Update the item name in selectedItems
                if (selectedItems[index]) {
                    selectedItems[index].name = newName;
                    
                    // Update the display name in the UI
                    const nameSpan = document.querySelector(`[data-index="${index}"] .item-name`);
                    if (nameSpan) {
                        nameSpan.textContent = newName;
                    }
                }
                
                // Update preview with debounce to prevent infinite loops
                clearTimeout(window.previewUpdateTimeout);
                window.previewUpdateTimeout = setTimeout(updatePreview, 300);
            }

            // Create specialized text blocks
            function createIntroBlock() {
                textBlockCounter++;
                const textBlockId = `intro-block-${textBlockCounter}`;
                const serverName = "{{ settings.server_name }}";
                const introContent = `You are receiving this email because you are a member of ${serverName}.`;
                const displayName = 'Intro: Member message';
                
                if (addItem(textBlockId, displayName, 'textblock')) {
                    // Set the content after the block is created
                    setTimeout(() => {
                        setTextBlockContent(textBlockId, introContent);
                    }, 100);
                    return textBlockId;
                }
                return null;
            }
            
            function createOutroBlock() {
                textBlockCounter++;
                const textBlockId = `outro-block-${textBlockCounter}`;
                const outroContent = 'Thanks for using Plex and for reading this newsletterr email!';
                const displayName = 'Outro: Thank you message';
                
                if (addItem(textBlockId, displayName, 'textblock')) {
                    // Set the content after the block is created
                    setTimeout(() => {
                        setTextBlockContent(textBlockId, outroContent);
                    }, 100);
                    return textBlockId;
                }
                return null;
            }
            
            function createTitleBlock() {
                titleBlockCounter++;
                const textBlockId = `title-block-${titleBlockCounter}`;
                const titleContent = 'Newsletter Title';
                const displayName = 'Title: Newsletter Title';
                
                if (addItem(textBlockId, displayName, 'titleblock')) {
                    // Set the content after the block is created
                    setTimeout(() => {
                        setTextBlockContent(textBlockId, titleContent);
                    }, 100);
                    return textBlockId;
                }
                return null;
            }

            // Event listeners for add buttons
            document.addEventListener('click', (e) => {
                if (e.target.id === 'add-text-block-btn') {
                    createTextBlock();
                }
                
                if (e.target.id === 'add-intro-btn') {
                    createIntroBlock();
                }
                
                if (e.target.id === 'add-outro-btn') {
                    createOutroBlock();
                }
                
                if (e.target.id === 'add-title-btn') {
                    createTitleBlock();
                }
                
                if (e.target.classList.contains('add-stat-btn') || e.target.classList.contains('add-graph-btn')) {
                    const id = e.target.dataset.id;
                    const name = e.target.dataset.name;
                    const type = e.target.dataset.type;
                    
                    console.log('Adding item:', { id, name, type });
                    console.log('Current selectedItems before:', selectedItems);
                    
                    if (addItem(id, name, type)) {
                        e.target.textContent = `Added`;
                        e.target.classList.remove('button');
                        e.target.classList.add('btn-success');
                        e.target.disabled = true;
                        console.log('Item added successfully. Current selectedItems:', selectedItems);
                    } else {
                        console.log('Item already exists');
                    }
                }
                
                if (e.target.classList.contains('remove-item-btn')) {
                    const index = parseInt(e.target.dataset.index);
                    removeItem(index);
                }
            });

            // Initialize
            updateSelectedItemsDisplay();
        </script>
        <script>
            document.getElementById('pullRecsBtn').addEventListener('click', async () => {
                showSpinner('Pulling recommendations...');

                function collectEmailsFromChips() {
                    return Array.from(document.querySelectorAll('#bcc_chips .nl-chip'))
                        .map(ch => ch.dataset.email)
                        .filter(Boolean);
                }

                const chipInput = document.getElementById('email_chip_input');
                    if (chipInput && chipInput.value.trim()) {
                        chipInput.dispatchEvent(new Event('blur'));
                }

                const toList = collectEmailsFromChips();
                    if (!toList.length) {
                        alert('Please add at least one recipient.');
                        return;
                }

                const to_emails = toList.join(', ');

                const payload = {
                    stats: {{ stats | tojson }},
                    user_dict: {{ user_dict | tojson }},
                    graph_data: {{ graph_data | tojson }},
                    graph_commands: {{ graph_commands | tojson }},
                    recent_data: {{ recent_data | tojson }},
                    libs: {{ libs | tojson }},
                    settings: {{ settings | tojson }},
                    to_emails
                };

                try {
                    const resp = await fetch('/pull_recommendations', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        credentials: 'same-origin'
                    });
                    
                    const data = await resp.json();
                    if (!resp.ok || !data.ok) throw new Error(data.error || 'Error pulling recommendations.');

                    const alert_p = document.getElementById('alert_p');
                    alert_p.textContent = data.alert;

                    const pane = document.getElementById('recommendations_pane');
                    pane.innerHTML = data.html;
                    initRecommendationsFilter(pane);
                } catch (err) {
                    console.error("Error pulling recommendations:", err);
                    const error_p= document.getElementById('error_p');
                    error_p.textContent = err;
                    alert("Something went wrong while pulling recommendations.");
                } finally {
                    try { hideSpinner(); } catch(_) {}
                }
            });
        </script>
        <script>
            function initRecommendationsFilter(rootEl) {
                const root = rootEl?.querySelector('#recommendations') || document.getElementById('recommendations') || rootEl || document;
                const sel = root?.querySelector('#rec-user-filter');
                const cards = Array.from(root?.querySelectorAll('.rec-user-card') || []);
                if (!sel || !cards.length) return;

                function apply() {
                    const opt = sel.options[sel.selectedIndex];
                    const val = sel.value;

                    if (val === "") {
                        cards.forEach(c => c.classList.add('hidden'));
                        return;
                    }

                    if (val === '__ALL__') {
                        cards.forEach(c => c.classList.remove('hidden'));
                        return;
                    }

                    cards.forEach(c => c.classList.toggle('hidden', c.dataset.user !== val));
                };

                sel.addEventListener('change', apply);
                apply();
            }
        </script>
        <script>
            function collectEmailsFromChips() {
                return Array.from(document.querySelectorAll('#bcc_chips .nl-chip'))
                    .map(ch => ch.dataset.email)
                    .filter(Boolean);
            }

            function blobToBase64(blob) {
                return new Promise(r => {
                    const fr = new FileReader();
                    fr.onload = () => r(fr.result.split(',')[1]);
                    fr.readAsDataURL(blob);
                });
            }

            document.getElementById('sendEmailBtn').addEventListener('click', async () => {
                const subject = document.getElementById('subject').value;
                
                // Collect text from all text blocks
                const textBlocks = selectedItems
                    .filter(item => item.type === 'textblock')
                    .map(item => getTextBlockContent(item.id))
                    .filter(content => content.trim().length > 0);
                
                let email_text = textBlocks.join('\n\n');

                const chipInput = document.getElementById('email_chip_input');
                    if (chipInput && chipInput.value.trim()) {
                        chipInput.dispatchEvent(new Event('blur'));
                }

                const toList = collectEmailsFromChips();
                    if (!toList.length) {
                        alert('Please add at least one recipient.');
                        return;
                }

                const to_emails = toList.join(', ');

                const ok = window.confirm(
                    `Send email?\n\nSubject: ${subject || '(no subject)'}\n\nRecipients (${toList.length}):\n${toList.join('\n')}`
                );
                if (!ok) return;

                showSpinner('Preparing email content...');

                // Extract actual HTML content from preview iframe
                let emailHTML = '';
                let emailImages = [];

                try {
                    const previewFrame = document.getElementById('preview');
                    console.log('Preview frame found:', !!previewFrame);
                    
                    const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                    console.log('Preview document found:', !!previewDoc);
                    console.log('Preview body found:', !!previewDoc?.body);
                    
                    if (previewDoc && previewDoc.body) {
                        // Wait a moment for content to fully load
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Get the actual HTML content from the preview
                        const previewHTML = previewDoc.documentElement.outerHTML;
                        console.log('Preview HTML length:', previewHTML.length);
                        console.log('Preview HTML preview:', previewHTML.substring(0, 500));
                        
                        // Process any Highcharts graphs by converting them to images
                        const charts = previewDoc.querySelectorAll('[data-highcharts-chart]');
                        console.log('Found charts:', charts.length);
                        
                        let processedHTML = previewHTML;
                        
                        // Convert each chart to an image and replace in HTML
                        for (let i = 0; i < charts.length; i++) {
                            const chart = charts[i];
                            const chartId = chart.id || `chart-${i}`;
                            
                            try {
                                // Get the Highcharts instance
                                const chartInstance = Highcharts.charts.find(c => c && c.container === chart);
                                if (chartInstance) {
                                    // Export chart as SVG then convert to image
                                    const svgData = chartInstance.getSVG();
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    const img = new Image();
                                    
                                    // Convert SVG to canvas
                                    const svgBlob = new Blob([svgData], {type: 'image/svg+xml'});
                                    const url = URL.createObjectURL(svgBlob);
                                    
                                    await new Promise((resolve, reject) => {
                                        img.onload = () => {
                                            canvas.width = img.width || 800;
                                            canvas.height = img.height || 400;
                                            ctx.drawImage(img, 0, 0);
                                            
                                            const imageData = canvas.toDataURL('image/png');
                                            const cid = `chart-${i}`;
                                            
                                            emailImages.push({
                                                cid: cid,
                                                mime: 'image/png',
                                                data: imageData
                                            });
                                            
                                            // Replace the chart div with an img tag
                                            processedHTML = processedHTML.replace(
                                                chart.outerHTML,
                                                `<img src="cid:${cid}" alt="Chart" style="max-width:100%;height:auto;">`
                                            );
                                            
                                            URL.revokeObjectURL(url);
                                            resolve();
                                        };
                                        img.onerror = reject;
                                        img.src = url;
                                    });
                                }
                            } catch (chartError) {
                                console.warn('Error processing chart:', chartError);
                            }
                        }
                        
                        // Clean up the HTML for email
                        emailHTML = processedHTML
                            .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '') // Remove scripts
                            .replace(/style="[^"]*"/gi, (match) => {
                                // Keep only basic styles, remove complex CSS
                                return match.includes('color') || match.includes('font') || match.includes('text-align') || 
                                       match.includes('background') || match.includes('padding') || match.includes('margin') ||
                                       match.includes('width') || match.includes('height') ? match : '';
                            });
                        
                        console.log('Processed email HTML length:', emailHTML.length);
                        
                        console.log('Email content prepared successfully');
                    } else {
                        throw new Error('Could not access preview content');
                    }
                } catch (error) {
                    console.error('Error preparing email content:', error);
                    // Fallback to basic text email
                    emailHTML = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>${subject || 'Newsletter'}</title>
                        </head>
                        <body style="font-family: Arial, sans-serif; padding: 20px; line-height: 1.6;">
                            <h2>${subject || 'Newsletter'}</h2>
                            <div>${email_text.replace(/\n/g, '<br>')}</div>
                        </body>
                        </html>
                    `;
                    console.log('Using fallback HTML:', emailHTML);
                }

                showSpinner('Sending email...');

                try {
                    console.log('Sending email with data:', {
                        to_emails,
                        subject,
                        email_html_length: emailHTML.length,
                        all_images_count: emailImages.length
                    });
                    
                    const resp = await fetch('/send_email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            to_emails,
                            subject,
                            email_html: emailHTML,
                            all_images: emailImages
                        })
                    });
                    
                    console.log('Response status:', resp.status);
                    
                    if (resp.ok) {
                        alert(`Email sent successfully to ${toList.length} recipient${toList.length !== 1 ? 's' : ''}!`);
                    } else {
                        const data = await resp.json();
                        console.error('Server error response:', data);
                        alert("Error sending email: " + data.error);
                    }
                } catch (err) {
                    console.error("Error sending email:", err);
                    alert("Something went wrong while sending the email.");
                }

                hideSpinner();
            });
        </script>
        <script>
            document.getElementById('stats_form').addEventListener('submit', (e) => {
                showSpinner('Getting stats and users...');
            });
        </script>
        <script>
            async function blurImageElement(imgElement) {
                const tempImg = new Image();
                tempImg.crossOrigin = 'anonymous';
                tempImg.src = imgElement.src;

                await new Promise((resolve, reject) => {
                    tempImg.onload = resolve;
                    tempImg.onerror = reject;
                });

                const rect = imgElement.getBoundingClientRect();
                const canvas = document.createElement('canvas');
                canvas.width = rect.width || 800;
                canvas.height = rect.height || 450;

                const ctx = canvas.getContext('2d');
                ctx.filter = 'blur(4px) brightness(0.75)';
                ctx.drawImage(tempImg, 0, 0, canvas.width, canvas.height);

                const blurredDataURL = canvas.toDataURL('image/png');
                imgElement.src = blurredDataURL;
                imgElement.style.position = 'absolute';
                imgElement.style.width = '100%';
                imgElement.style.height = '100%';
                imgElement.style.objectFit = 'cover';
                imgElement.style.zIndex = '0';
                imgElement.style.filter = 'none';
            }
        </script>
        <script>
            (function () {
                const box = document.getElementById('bcc_chips');
                const input = document.getElementById('email_chip_input');
                const ta = document.getElementById('to_emails');

                if (!box || !input || !ta) return;

                function normalize(token) {
                    const m = String(token).match(/<([^>]+)>/);
                    return (m ? m[1] : token).trim().toLowerCase();
                }
                function isEmail(s) {
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
                }

                function syncHiddenFromDOM() {
                    const list = Array.from(box.querySelectorAll('.nl-chip'))
                    .map(ch => ch.dataset.email)
                    .filter(Boolean);
                    ta.value = list.join(', ');
                    input.placeholder = list.length ? '' : 'Add BCC emails';
                }

                function makeChip(email) {
                    const chip = document.createElement('span');
                    chip.className = 'nl-chip';
                    chip.dataset.email = email;
                    chip.innerHTML = `
                        <span>${email}</span>
                        <button type="button" class="remove" aria-label="Remove ${email}">x</button>
                    `;
                    return chip;
                }

                function addEmail(email) {
                    if (!email || !isEmail(email)) return;
                    const sel = `.nl-chip[data-email="${CSS.escape(email)}"]`;
                    if (box.querySelector(sel)) return;
                    box.insertBefore(makeChip(email), input);
                    syncHiddenFromDOM();
                }

                function addTokens(str) {
                    String(str).split(/[,\n;\s]+/).filter(Boolean).forEach(t => {
                        addEmail(normalize(t));
                    });
                }

                addTokens(ta.value || '');

                input.addEventListener('keydown', (e) => {
                    if (['Enter', 'Tab'].includes(e.key) || e.key === ',' || e.key === ';') {
                        e.preventDefault();
                        if (input.value.trim()) { addTokens(input.value); input.value = ''; }
                    } else if (e.key === 'Backspace' && !input.value) {
                        const last = box.querySelector('.nl-chip:last-of-type');
                        if (last) { last.remove(); syncHiddenFromDOM(); }
                    }
                });

                input.addEventListener('paste', (e) => {
                    const text = (e.clipboardData || window.clipboardData).getData('text');
                    if (/[,\n;\s]/.test(text)) { e.preventDefault(); addTokens(text); }
                });

                input.addEventListener('blur', () => {
                    if (input.value.trim()) { addTokens(input.value); input.value = ''; }
                });

                box.addEventListener('click', (e) => {
                    const btn = e.target.closest('.remove');
                    if (!btn) return;
                    const chip = btn.closest('.nl-chip');
                    if (chip) { chip.remove(); syncHiddenFromDOM(); }
                });

                new MutationObserver(syncHiddenFromDOM).observe(box, { childList: true });

                document.getElementById('sendEmailBtn')?.addEventListener('click', () => {
                    if (input.value.trim()) { addTokens(input.value); input.value = ''; }
                    syncHiddenFromDOM();
                });

                syncHiddenFromDOM();
            })();
        </script>
        <script>
            // Email List Management
            document.addEventListener('DOMContentLoaded', () => {
                const selector = document.getElementById('email_list_selector');
                const deleteBtn = document.getElementById('delete_list_btn');
                const saveContainer = document.getElementById('save_list_container');
                const newListNameInput = document.getElementById('new_list_name');
                const saveBtn = document.getElementById('save_list_btn');
                const cancelBtn = document.getElementById('cancel_save_btn');
                const bccChipsContainer = document.getElementById('bcc_chips');
                const emailInput = document.getElementById('email_chip_input');
                
                const allUserEmails = {{ user_dict.values() | list | tojson }};
                
                function collectEmailsFromChips() {
                    return Array.from(document.querySelectorAll('#bcc_chips .nl-chip'))
                        .map(ch => ch.dataset.email)
                        .filter(Boolean);
                }
                
                function clearAllChips() {
                    document.querySelectorAll('#bcc_chips .nl-chip').forEach(chip => chip.remove());
                }
                
                function addEmailChip(email) {
                    if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return;
                    const sel = `.nl-chip[data-email="${CSS.escape(email)}"]`;
                    if (bccChipsContainer.querySelector(sel)) return;
                    
                    const chip = document.createElement('span');
                    chip.className = 'nl-chip';
                    chip.dataset.email = email;
                    chip.innerHTML = `
                        <span>${email}</span>
                        <button type="button" class="remove" aria-label="Remove ${email}">x</button>
                    `;
                    bccChipsContainer.insertBefore(chip, emailInput);
                }
                
                function setReadOnlyMode(readOnly) {
                    const chips = document.querySelectorAll('#bcc_chips .nl-chip .remove');
                    chips.forEach(btn => {
                        btn.style.display = readOnly ? 'none' : 'inline';
                    });
                    emailInput.disabled = readOnly;
                    if (readOnly) {
                        emailInput.placeholder = 'Read-only mode';
                    } else {
                        emailInput.placeholder = 'Add BCC emails';
                    }
                }
                
                // Handle list selection change
                selector.addEventListener('change', async () => {
                    const selectedValue = selector.value;
                    
                    // Hide delete button and save container by default
                    deleteBtn.classList.add('d-none');
                    saveContainer.classList.add('d-none');
                    
                    if (selectedValue === 'Custom') {
                        setReadOnlyMode(false);
                        // Keep current emails
                    } else if (selectedValue === 'ALL') {
                        clearAllChips();
                        allUserEmails.forEach(email => addEmailChip(email));
                        setReadOnlyMode(true);
                    } else if (selectedValue === '(Save new list)') {
                        saveContainer.classList.remove('d-none');
                        newListNameInput.focus();
                        setReadOnlyMode(false);
                    } else {
                        // Load saved list
                        const option = selector.querySelector(`option[value="${selectedValue}"]`);
                        if (option) {
                            const emails = option.dataset.emails;
                            clearAllChips();
                            emails.split(', ').forEach(email => addEmailChip(email.trim()));
                            deleteBtn.classList.remove('d-none');
                            setReadOnlyMode(false);
                        }
                    }
                });
                
                // Handle save new list
                saveBtn.addEventListener('click', async () => {
                    const name = newListNameInput.value.trim();
                    if (!name) {
                        alert('Please enter a list name');
                        return;
                    }
                    
                    const emails = collectEmailsFromChips();
                    if (emails.length === 0) {
                        alert('Cannot save empty email list');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/email_lists', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: name,
                                emails: emails.join(', ')
                            })
                        });
                        
                        const result = await response.json();
                        if (result.status === 'success') {
                            // Add new option to selector
                            const newOption = document.createElement('option');
                            newOption.value = 'temp_' + Date.now(); // Temporary ID
                            newOption.textContent = name;
                            newOption.dataset.emails = emails.join(', ');
                            selector.insertBefore(newOption, selector.querySelector('option[value="(Save new list)"]'));
                            
                            // Select the new list and hide save container
                            selector.value = newOption.value;
                            saveContainer.classList.add('d-none');
                            newListNameInput.value = '';
                            deleteBtn.classList.remove('d-none');
                            
                            alert(result.message);
                            
                            // Refresh the page to get proper IDs from server
                            setTimeout(() => window.location.reload(), 1000);
                        } else {
                            alert(result.message);
                        }
                    } catch (error) {
                        alert('Error saving list: ' + error.message);
                    }
                });
                
                // Handle cancel save
                cancelBtn.addEventListener('click', () => {
                    saveContainer.classList.add('d-none');
                    newListNameInput.value = '';
                    selector.value = 'Custom';
                });
                
                // Handle delete list
                deleteBtn.addEventListener('click', async () => {
                    const selectedValue = selector.value;
                    const option = selector.querySelector(`option[value="${selectedValue}"]`);
                    
                    if (!option || !confirm(`Delete list "${option.textContent}"?`)) return;
                    
                    try {
                        const response = await fetch(`/email_lists/${selectedValue}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        if (result.status === 'success') {
                            option.remove();
                            selector.value = 'Custom';
                            deleteBtn.classList.add('d-none');
                            alert(result.message);
                        } else {
                            alert(result.message);
                        }
                    } catch (error) {
                        alert('Error deleting list: ' + error.message);
                    }
                });
                
                // Initialize with Custom mode
                setReadOnlyMode(false);
            });
        </script>
        <script>
            // Handle BCC collapse toggle
            document.addEventListener('DOMContentLoaded', () => {
                const bccHeader = document.querySelector('[onclick*="bcc-collapse"]');
                if (bccHeader) {
                    bccHeader.addEventListener('click', () => {
                        const icon = document.getElementById('bcc-toggle-icon');
                        const collapse = document.getElementById('bcc-collapse');
                        if (collapse.classList.contains('d-none')) {
                            icon.style.transform = 'rotate(0deg)';
                            icon.textContent = '▼';
                        } else {
                            icon.style.transform = 'rotate(-90deg)';
                            icon.textContent = '▶';
                        }
                    });
                }
                
                // Initially collapse the BCC section
                document.getElementById('bcc-collapse').classList.add('d-none');
                document.getElementById('bcc-toggle-icon').style.transform = 'rotate(-90deg)';
                document.getElementById('bcc-toggle-icon').textContent = '▶';
                
                // Handle cache clear button
                const clearCacheBtn = document.getElementById('clear_cache_btn');
                if (clearCacheBtn) {
                    clearCacheBtn.addEventListener('click', async () => {
                        try {
                            clearCacheBtn.textContent = 'Clearing...';
                            clearCacheBtn.disabled = true;
                            
                            const response = await fetch('/clear_cache', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                clearCacheBtn.textContent = 'Cleared!';
                                clearCacheBtn.style.backgroundColor = '#28a745';
                                setTimeout(() => {
                                    clearCacheBtn.textContent = 'Clear Cache';
                                    clearCacheBtn.style.backgroundColor = '#dc3545';
                                    clearCacheBtn.disabled = false;
                                }, 2000);
                            } else {
                                throw new Error('Failed to clear cache');
                            }
                        } catch (error) {
                            console.error('Error clearing cache:', error);
                            clearCacheBtn.textContent = 'Error';
                            clearCacheBtn.style.backgroundColor = '#dc3545';
                            setTimeout(() => {
                                clearCacheBtn.textContent = 'Clear Cache';
                                clearCacheBtn.disabled = false;
                            }, 2000);
                        }
                    });
                }
            });

            // Email Template Management
            let emailTemplates = [];

            // Load templates on page load
            async function loadEmailTemplates() {
                try {
                    const response = await fetch('/email_templates');
                    emailTemplates = await response.json();
                    updateTemplateDropdown();
                } catch (error) {
                    console.error('Error loading templates:', error);
                }
            }

            function updateTemplateDropdown() {
                const selector = document.getElementById('template-selector');
                
                // Clear existing options except first two
                while (selector.children.length > 2) {
                    selector.removeChild(selector.lastChild);
                }
                
                // Add templates in alphabetical order
                emailTemplates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    selector.appendChild(option);
                });
            }

            // Template selector change handler
            document.getElementById('template-selector').addEventListener('change', async function() {
                const value = this.value;
                const deleteBtn = document.getElementById('delete-template-btn');
                
                if (value === 'save-template') {
                    // Show save template dialog
                    const templateName = prompt('Enter template name:');
                    if (templateName && templateName.trim()) {
                        await saveCurrentTemplate(templateName.trim());
                    }
                    // Reset to Custom
                    this.value = '';
                    deleteBtn.style.display = 'none';
                } else if (value === '') {
                    // Custom - clear everything
                    deleteBtn.style.display = 'none';
                } else {
                    // Load template
                    const templateId = parseInt(value);
                    const template = emailTemplates.find(t => t.id === templateId);
                    if (template) {
                        loadTemplate(template);
                        deleteBtn.style.display = 'inline-block';
                        deleteBtn.dataset.templateId = templateId;
                    }
                }
            });

            // Reset button handler
            document.getElementById('reset-template-btn').addEventListener('click', function() {
                // Confirm the reset action
                if (confirm('Are you sure you want to reset? This will clear all selected items and reset to Custom template.')) {
                    // Clear all selected items
                    selectedItems.length = 0;
                    
                    // Reset template selector to Custom
                    document.getElementById('template-selector').value = '';
                    
                    // Hide delete button
                    document.getElementById('delete-template-btn').style.display = 'none';
                    
                    // Reset all add buttons to original state
                    document.querySelectorAll('.add-stat-btn, .add-graph-btn').forEach(btn => {
                        btn.textContent = 'Add';
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-primary');
                        btn.disabled = false;
                    });
                    
                    // Update the display
                    updateSelectedItemsDisplay();
                    
                    // Reset text block counter
                    textBlockCounter = 0;
                }
            });

            // Save current template
            async function saveCurrentTemplate(name) {
                try {
                    // Collect text from all text blocks (including title blocks)
                    const textBlocks = selectedItems
                        .filter(item => item.type === 'textblock' || item.type === 'titleblock')
                        .map(item => getTextBlockContent(item.id))
                        .filter(content => content.trim().length > 0);
                    
                    // Also store individual text block contents in selected_items for better processing
                    const itemsWithContent = selectedItems.map(item => {
                        if (item.type === 'textblock' || item.type === 'titleblock') {
                            return {
                                ...item,
                                content: getTextBlockContent(item.id) || ''
                            };
                        }
                        return item;
                    });
                    
                    const templateData = {
                        name: name,
                        selected_items: JSON.stringify(itemsWithContent),
                        email_text: textBlocks.join('\n\n'),
                        subject: document.getElementById('subject').value
                    };

                    const response = await fetch('/email_templates', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(templateData)
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        console.log('Template saved successfully');
                        await loadEmailTemplates(); // Reload templates
                    } else {
                        alert('Error saving template: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error saving template:', error);
                    alert('Error saving template');
                }
            }

            // Load template into form
            function loadTemplate(template) {
                try {
                    // Parse selected items
                    const items = JSON.parse(template.selected_items);
                    
                    // Clear current selection
                    selectedItems = [];
                    
                    // Reset all buttons to original state
                    document.querySelectorAll('.add-stat-btn, .add-graph-btn').forEach(btn => {
                        btn.textContent = 'Add';
                        btn.classList.remove('btn-success');
                        btn.classList.add('button');
                        btn.disabled = false;
                    });
                    
                    // Load template items in order, preserving types and content
                    selectedItems = items.map(item => {
                        // For text and title blocks, restore the content
                        if ((item.type === 'textblock' || item.type === 'titleblock') && item.content) {
                            // Ensure we have the right counter for new blocks
                            if (item.type === 'textblock' && item.id.startsWith('text-block-')) {
                                const counter = parseInt(item.id.split('-')[2]);
                                if (counter >= textBlockCounter) {
                                    textBlockCounter = counter;
                                }
                            } else if (item.type === 'titleblock' && item.id.startsWith('title-block-')) {
                                const counter = parseInt(item.id.split('-')[2]);
                                if (counter >= titleBlockCounter) {
                                    titleBlockCounter = counter;
                                }
                            } else if (item.type === 'textblock' && item.id.startsWith('intro-block-')) {
                                const counter = parseInt(item.id.split('-')[2]);
                                if (counter >= textBlockCounter) {
                                    textBlockCounter = counter;
                                }
                            } else if (item.type === 'textblock' && item.id.startsWith('outro-block-')) {
                                const counter = parseInt(item.id.split('-')[2]);
                                if (counter >= textBlockCounter) {
                                    textBlockCounter = counter;
                                }
                            }
                        }
                        return { ...item };
                    });
                    
                    // Render any graphs that need to be rendered
                    selectedItems.forEach(item => {
                        if (item.type === 'graph' && !renderedCharts.has(item.id)) {
                            try {
                                const index = parseInt(item.id.split('-')[1]);
                                const graphData = graphDataList[index];

                                if (graphData && graphCommands[index]) {
                                    Highcharts.chart(item.id, {
                                        chart: { type: 'line' },
                                        title: { text: graphCommands[index].name },
                                        exporting: {
                                            enabled: true
                                        },
                                        xAxis: { categories: graphData.categories },
                                        yAxis: { title: { text: 'Plays' } },
                                        series: graphData.series
                                    });

                                    renderedCharts.add(item.id);
                                    
                                    // Apply current theme
                                    const nowDark = document.documentElement.classList.contains('dark');
                                    applyChartTheme(nowDark);
                                    
                                    console.log('Auto-rendered graph during template load:', item.id);
                                }
                            } catch (error) {
                                console.warn('Failed to auto-render graph during template load', item.id, error);
                            }
                        }
                    });
                    
                    // Update button states for selected items
                    selectedItems.forEach(item => {
                        const button = document.querySelector(`[data-id="${item.id}"]`);
                        if (button) {
                            button.textContent = 'Added';
                            button.classList.remove('button');
                            button.classList.add('btn-success');
                            button.disabled = true;
                        }
                    });
                    
                    // Load form fields
                    document.getElementById('subject').value = template.subject || '';
                    
                    // Update display and preview
                    updateSelectedItemsDisplay();
                    
                    // After the display is updated, set the content for text/title blocks
                    setTimeout(() => {
                        selectedItems.forEach(item => {
                            if ((item.type === 'textblock' || item.type === 'titleblock') && item.content) {
                                setTextBlockContent(item.id, item.content);
                            }
                        });
                        // Update preview after content is set
                        updatePreview();
                    }, 100);
                    
                    console.log('Template loaded:', template.name);
                } catch (error) {
                    console.error('Error loading template:', error);
                    alert('Error loading template');
                }
            }

            // Delete template
            document.getElementById('delete-template-btn').addEventListener('click', async function() {
                const templateId = this.dataset.templateId;
                if (!templateId) return;
                
                const template = emailTemplates.find(t => t.id == templateId);
                if (!template) return;
                
                if (confirm(`Are you sure you want to delete the template "${template.name}"?`)) {
                    try {
                        const response = await fetch(`/email_templates/${templateId}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        if (result.status === 'success') {
                            console.log('Template deleted successfully');
                            await loadEmailTemplates(); // Reload templates
                            
                            // Reset to Custom
                            document.getElementById('template-selector').value = '';
                            this.style.display = 'none';
                        } else {
                            alert('Error deleting template: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Error deleting template:', error);
                        alert('Error deleting template');
                    }
                }
            });

            // Pop-out preview functionality
            document.getElementById('popout-preview-btn').addEventListener('click', function() {
                const frame = document.getElementById('preview');
                if (!frame || !frame.srcdoc) {
                    alert('No preview content available');
                    return;
                }
                
                // Create a new window
                const popupWindow = window.open('', 'EmailPreview', 'width=800,height=600,scrollbars=yes,resizable=yes');
                
                if (popupWindow) {
                    // Write the preview content to the new window
                    popupWindow.document.open();
                    popupWindow.document.write(frame.srcdoc);
                    popupWindow.document.close();
                    
                    // Set window title
                    popupWindow.document.title = 'Email Preview';
                    
                    // Focus the new window
                    popupWindow.focus();
                } else {
                    alert('Pop-up blocked! Please allow pop-ups for this site to use the preview feature.');
                }
            });

            // Load templates on page load
            document.addEventListener('DOMContentLoaded', () => {
                loadEmailTemplates();
            });
        </script>
    </div>
</div>
{% endblock %}
